<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B4 Project Dashboard</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0d1117;
            color: #c9d1d9;
            padding: 20px;
            line-height: 1.5;
        }
        .container { max-width: 1600px; margin: 0 auto; }
        h1 { color: #58a6ff; margin-bottom: 5px; }
        .subtitle { color: #8b949e; margin-bottom: 20px; }
        .main-layout { display: grid; grid-template-columns: 220px 1fr; gap: 20px; }
        .sidebar { height: fit-content; }
        .content-area { display: flex; flex-direction: column; gap: 20px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
        @media (max-width: 1200px) { .main-layout { grid-template-columns: 1fr; } .grid-3 { grid-template-columns: 1fr; } }
        .card {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 16px;
        }
        .card h2 {
            color: #58a6ff;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #30363d;
        }
        .status-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        .status-done { background: #238636; color: #fff; }
        .status-in_progress, .status-progress { background: #1f6feb; color: #fff; }
        .status-blocked { background: #da3633; color: #fff; }
        .status-backlog { background: #30363d; color: #8b949e; }
        .status-new, .status-todo { background: #6e7681; color: #fff; }

        .milestone-list { display: flex; flex-wrap: wrap; gap: 8px; }
        .milestone-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: #21262d;
            border-radius: 6px;
            font-size: 13px;
        }
        .milestone-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        .dot-done { background: #238636; }
        .dot-in_progress { background: #1f6feb; }
        .dot-blocked { background: #da3633; }
        .dot-backlog { background: #484f58; }

        .priority-list { list-style: none; }
        .priority-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #21262d;
        }
        .priority-item:last-child { border-bottom: none; }
        .priority-num {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 22px;
            height: 22px;
            background: #da3633;
            color: #fff;
            border-radius: 50%;
            font-size: 12px;
            font-weight: bold;
            margin-right: 10px;
        }
        .priority-ticket {
            color: #58a6ff;
            text-decoration: none;
            font-family: monospace;
        }
        .priority-ticket:hover { text-decoration: underline; }

        .metrics-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .metric-box {
            background: #21262d;
            padding: 12px;
            border-radius: 6px;
            text-align: center;
        }
        .metric-value { font-size: 28px; font-weight: bold; color: #58a6ff; }
        .metric-label { font-size: 12px; color: #8b949e; }

        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { text-align: left; color: #8b949e; font-weight: 500; padding: 8px 6px; border-bottom: 1px solid #30363d; }
        td { padding: 8px 6px; border-bottom: 1px solid #21262d; }
        tr:hover { background: #21262d; }
        .ticket-link { color: #58a6ff; text-decoration: none; font-family: monospace; }
        .ticket-link:hover { text-decoration: underline; }
        .truncate { max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        .links-list a {
            display: block;
            color: #58a6ff;
            text-decoration: none;
            padding: 8px 0;
            border-bottom: 1px solid #21262d;
        }
        .links-list a:hover { background: #21262d; margin: 0 -16px; padding: 8px 16px; }
        .links-list a:last-child { border-bottom: none; }

        .links-list .dropdown { position: relative; border-bottom: 1px solid #21262d; }
        .links-list .dropdown-toggle {
            display: block;
            color: #58a6ff;
            text-decoration: none;
            padding: 8px 0;
            cursor: pointer;
        }
        .links-list .dropdown-toggle:hover { background: #21262d; margin: 0 -16px; padding: 8px 16px; }
        .links-list .dropdown-menu {
            display: none;
            padding-left: 16px;
            background: #21262d;
            margin: 0 -16px;
            padding: 4px 16px 8px;
        }
        .links-list .dropdown.open .dropdown-menu { display: block; }
        .links-list .dropdown-menu a {
            padding: 6px 0;
            font-size: 13px;
            border-bottom: none;
        }
        .links-list .dropdown-menu a:hover { background: #30363d; margin: 0 -8px; padding: 6px 8px; border-radius: 4px; }

        .status-bar { display: flex; height: 8px; border-radius: 4px; overflow: hidden; margin-top: 8px; }
        .status-segment { height: 100%; }

        .updated { text-align: right; color: #484f58; font-size: 12px; margin-top: 20px; }
        .error { color: #f85149; padding: 20px; text-align: center; }

        .full-width { grid-column: 1 / -1; }
        .scroll-table { max-height: 300px; overflow-y: auto; }

        .pagination {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #21262d;
        }
        .pagination button {
            background: #21262d;
            border: 1px solid #30363d;
            color: #c9d1d9;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
        }
        .pagination button:hover { background: #30363d; }
        .pagination button:disabled { opacity: 0.5; cursor: not-allowed; }
        .pagination button.active { background: #1f6feb; border-color: #1f6feb; }
        .pagination .page-info { color: #8b949e; font-size: 13px; line-height: 32px; }

        .filter-bar {
            background: #21262d;
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .filter-bar span { color: #8b949e; }
        .filter-bar .filter-value { color: #58a6ff; font-weight: 500; }
        .filter-bar button {
            background: #da3633;
            border: none;
            color: #fff;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .clickable { cursor: pointer; }
        .clickable:hover { text-decoration: underline; }
        .sortable { cursor: pointer; user-select: none; }
        .sortable:hover { background: #30363d; }

        .chart-fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #0d1117;
            z-index: 1000;
            padding: 20px;
            box-sizing: border-box;
        }
        .chart-fullscreen .close-btn {
            position: absolute;
            top: 20px;
            right: 30px;
            background: #da3633;
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            z-index: 1001;
        }
        .chart-fullscreen .close-btn:hover { background: #f85149; }
        .chart-fullscreen h2 { color: #58a6ff; margin-bottom: 20px; }
        .chart-container { cursor: pointer; }
        .chart-container:hover { opacity: 0.9; }

        #refresh-btn {
            background: #238636;
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.2s;
        }
        #refresh-btn:hover { background: #2ea043; }
        #refresh-btn:disabled { background: #484f58; cursor: wait; }
        #refresh-btn.loading { animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
    </style>
</head>
<body>
    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h1>üöó B4 Project Dashboard</h1>
                <p class="subtitle" id="project-phase">Loading...</p>
            </div>
            <button id="refresh-btn" onclick="refreshData()">üîÑ Refresh Data</button>
        </div>

        <div class="main-layout">
            <!-- Left Sidebar - Quick Links -->
            <div class="sidebar">
                <div class="card">
                    <h2>üîó Quick Links</h2>
                    <div class="links-list" id="links">Loading...</div>
                </div>
            </div>

            <!-- Main Content Area -->
            <div class="content-area">
                <!-- Top Row: Releases (wide) + Milestones -->
                <div class="grid" style="grid-template-columns: 2fr 1fr;">
                    <!-- Releases -->
                    <div class="card">
                        <h2><a href="https://getnexar.atlassian.net/projects/FS?selectedItem=com.atlassian.jira.jira-projects-plugin%3Arelease-page&status=no-filter" target="_blank" style="color: inherit; text-decoration: none;">üöÄ Releases ‚Üó</a></h2>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div>
                                <h3 style="color: #8b949e; font-size: 12px; margin-bottom: 8px;">FW Releases</h3>
                                <div class="scroll-table" style="max-height: 200px;">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>Version</th>
                                                <th>Status</th>
                                                <th>Date</th>
                                            </tr>
                                        </thead>
                                        <tbody id="fw-releases-body">Loading...</tbody>
                                    </table>
                                </div>
                            </div>
                            <div>
                                <h3 style="color: #8b949e; font-size: 12px; margin-bottom: 8px;">MCU Releases</h3>
                                <div>
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>Version</th>
                                                <th>Status</th>
                                                <th>Date</th>
                                            </tr>
                                        </thead>
                                        <tbody id="mcu-releases-body">Loading...</tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Milestones -->
                    <div class="card">
                        <h2>üìç Milestones</h2>
                        <div class="scroll-table" style="max-height: 200px;">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Milestone</th>
                                        <th>Status</th>
                                        <th>Date</th>
                                    </tr>
                                </thead>
                                <tbody id="milestones">Loading...</tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Second Row: Priorities + Metrics -->
                <div class="grid">
                    <!-- Top Priorities -->
                    <div class="card">
                        <h2>üéØ Top 5 Priorities</h2>
                        <ul class="priority-list" id="priorities">Loading...</ul>
                    </div>

                    <!-- Metrics -->
                    <div class="card">
                        <h2>üìä Metrics</h2>
                        <div class="metrics-grid" id="metrics">Loading...</div>
                    </div>
                </div>

            </div>

            <!-- Velocity Chart (full width) -->
            <div class="card chart-container" style="margin-top: 20px; grid-column: 1 / -1;" onclick="openChartFullscreen()">
                <h2>üìà Velocity Chart (Last 8 Weeks) <span style="font-size: 12px; color: #8b949e;">(click to expand)</span></h2>
                <div style="height: 280px;">
                    <canvas id="velocity-chart"></canvas>
                </div>
            </div>

            <!-- Fullscreen Chart Overlay -->
            <div id="chart-fullscreen" class="chart-fullscreen" style="display: none;">
                <button class="close-btn" onclick="closeChartFullscreen()">‚úï Close</button>
                <h2>üìà Velocity Chart (Last 8 Weeks)</h2>
                <div style="height: calc(100vh - 100px);">
                    <canvas id="velocity-chart-full"></canvas>
                </div>
            </div>

            <div class="content-area" style="margin-top: 0; grid-column: 1 / -1;">

                <!-- BR Bugs (full width) -->
                <div class="card">
                    <h2><a id="bugs-link" href="#" target="_blank" style="color: inherit; text-decoration: none;">üêõ BR Bugs (<span id="bugs-count">0</span>) ‚Üó</a></h2>
                    <div id="bugs-filter" class="filter-bar" style="display:none;"></div>
                    <table id="bugs-table" style="width: 100%;">
                        <thead>
                            <tr>
                                <th class="sortable" onclick="sortBugs('key')">Key <span id="bugs-sort-key"></span></th>
                                <th class="sortable" onclick="sortBugs('summary')">Summary <span id="bugs-sort-summary"></span></th>
                                <th class="sortable" onclick="sortBugs('status')">Status <span id="bugs-sort-status"></span></th>
                                <th class="sortable" onclick="sortBugs('assignee')">Assignee <span id="bugs-sort-assignee"></span></th>
                                <th class="sortable" onclick="sortBugs('priority')">Priority <span id="bugs-sort-priority"></span></th>
                                <th class="sortable" onclick="sortBugs('version')">Version <span id="bugs-sort-version"></span></th>
                            </tr>
                        </thead>
                        <tbody id="bugs-body">Loading...</tbody>
                    </table>
                    <div class="pagination" id="bugs-pagination"></div>
                </div>

                <!-- FS Tickets (full width) -->
                <div class="card">
                    <h2><a id="tickets-link" href="#" target="_blank" style="color: inherit; text-decoration: none;">üìã FS Tickets (<span id="tickets-count">0</span>) ‚Üó</a></h2>
                    <div id="tickets-filter" class="filter-bar" style="display:none;"></div>
                    <table id="tickets-table" style="width: 100%;">
                        <thead>
                            <tr>
                                <th class="sortable" onclick="sortTickets('key')">Key <span id="tickets-sort-key"></span></th>
                                <th class="sortable" onclick="sortTickets('summary')">Summary <span id="tickets-sort-summary"></span></th>
                                <th class="sortable" onclick="sortTickets('status')">Status <span id="tickets-sort-status"></span></th>
                                <th class="sortable" onclick="sortTickets('assignee')">Assignee <span id="tickets-sort-assignee"></span></th>
                                <th class="sortable" onclick="sortTickets('priority')">Priority <span id="tickets-sort-priority"></span></th>
                                <th class="sortable" onclick="sortTickets('version')">Version <span id="tickets-sort-version"></span></th>
                            </tr>
                        </thead>
                        <tbody id="tickets-body">Loading...</tbody>
                    </table>
                    <div class="pagination" id="tickets-pagination"></div>
                </div>
            </div>
        </div>

        <p class="updated" id="updated"></p>
    </div>

    <script>
        async function loadDashboard() {
            try {
                const response = await fetch('data/dashboard.json?t=' + Date.now());
                if (!response.ok) throw new Error('Data not found. Run: python3 fetch_data.py');
                const data = await response.json();
                renderDashboard(data);
            } catch (error) {
                document.querySelector('.grid').innerHTML = `
                    <div class="card full-width">
                        <div class="error">
                            <h2>‚ö†Ô∏è Could not load data</h2>
                            <p>${error.message}</p>
                            <p style="margin-top: 10px; color: #8b949e;">Run: <code>python3 fetch_data.py</code> first</p>
                        </div>
                    </div>
                `;
            }
        }

        function renderDashboard(data) {
            // Project phase
            document.getElementById('project-phase').textContent =
                `${data.project.name} ‚Ä¢ ${data.project.phase}`;

            // Milestones (table)
            const milestonesHtml = data.milestones.map(m => {
                if (m.status === 'empty') {
                    return '<tr style="height:28px;"><td></td><td></td><td></td></tr>';
                }
                const statusText = m.status === 'done' ? '‚úì Done' : m.status === 'in_progress' ? '‚óè Active' : m.status === 'blocked' ? '‚äò Blocked' : '‚óã Backlog';
                return `<tr>
                    <td>${m.name}</td>
                    <td><span class="status-badge status-${m.status}">${statusText}</span></td>
                    <td>${m.date || '-'}</td>
                </tr>`;
            }).join('');
            document.getElementById('milestones').innerHTML = milestonesHtml;

            // Metrics
            const metricsHtml = `
                <div class="metric-box">
                    <div class="metric-value">${data.metrics.total_bugs}</div>
                    <div class="metric-label">Open Bugs</div>
                </div>
                <div class="metric-box">
                    <div class="metric-value">${data.metrics.total_tickets}</div>
                    <div class="metric-label">FS Tickets</div>
                </div>
                <div class="metric-box">
                    <div class="metric-value">${data.metrics.bug_status['In Progress'] || 0}</div>
                    <div class="metric-label">Bugs In Progress</div>
                </div>
                <div class="metric-box">
                    <div class="metric-value">${data.metrics.ticket_status['In Progress'] || 0}</div>
                    <div class="metric-label">Tickets In Progress</div>
                </div>
            `;
            document.getElementById('metrics').innerHTML = metricsHtml;

            // FW Releases
            const fwReleasesHtml = (data.fw_releases || []).map(r => {
                if (!r.name) return '';
                return `<tr>
                    <td><a class="ticket-link" href="${r.url}" target="_blank">${r.name.replace('fw2-b4-', '')}</a></td>
                    <td><span class="status-badge ${r.released ? 'status-done' : 'status-in_progress'}">${r.released ? '‚úì' : '‚óã'}</span></td>
                    <td>${r.releaseDate || '-'}</td>
                </tr>`;
            }).join('');
            document.getElementById('fw-releases-body').innerHTML = fwReleasesHtml || '<tr><td colspan="3">No releases</td></tr>';

            // MCU Releases
            const mcuReleasesHtml = (data.mcu_releases || []).map(r => {
                if (!r.name) return '';
                return `<tr>
                    <td><a class="ticket-link" href="${r.url}" target="_blank">${r.name.replace('mcu-b4-', '')}</a></td>
                    <td><span class="status-badge ${r.released ? 'status-done' : 'status-in_progress'}">${r.released ? '‚úì' : '‚óã'}</span></td>
                    <td>${r.releaseDate || '-'}</td>
                </tr>`;
            }).join('');
            document.getElementById('mcu-releases-body').innerHTML = mcuReleasesHtml || '<tr><td colspan="3">No MCU releases</td></tr>';

            // Priorities
            const prioritiesHtml = data.priorities.map((p, i) => `
                <li class="priority-item">
                    <span><span class="priority-num">${i + 1}</span>${p.title}</span>
                    <a class="priority-ticket" href="${p.url || 'https://getnexar.atlassian.net/browse/' + p.ticket}" target="_blank">${p.ticket}</a>
                </li>
            `).join('');
            document.getElementById('priorities').innerHTML = prioritiesHtml || '<li>No priorities in active sprint</li>';

            // Links
            const linksHtml = `
                <a href="${data.links.timeline}" target="_blank" style="background:#238636;color:#fff;padding:8px 12px;border-radius:6px;font-weight:500;">üìÖ Project Timeline</a>
                <a href="${data.links.release_plan}" target="_blank">üìÑ Release Plan (Confluence)</a>
                <div class="dropdown">
                    <a href="#" class="dropdown-toggle" onclick="event.preventDefault(); this.parentElement.classList.toggle('open')">üìã JIRA Internal ‚ñæ</a>
                    <div class="dropdown-menu">
                        <a href="${data.links.jira_board}" target="_blank">FS Board (Backlog)</a>
                        <a href="${data.links.br_bugs}" target="_blank">BR Bugs (Beam4)</a>
                    </div>
                </div>
                <div class="dropdown">
                    <a href="#" class="dropdown-toggle" onclick="event.preventDefault(); this.parentElement.classList.toggle('open')">üè≠ JIRA External ‚ñæ</a>
                    <div class="dropdown-menu">
                        <a href="${data.links.chicony_jira}" target="_blank">B4 (Chicony)</a>
                        <a href="${data.links.dastic_jira}" target="_blank">DAS (Dastic)</a>
                        <a href="https://getnexar-acko.atlassian.net/jira/software/projects/KAN/boards/1" target="_blank">PICO (Acko)</a>
                    </div>
                </div>
                <a href="${data.links.sprint_planning}" target="_blank">üóìÔ∏è ${data.links.sprint_title || 'Sprint Planning'}</a>
                <a href="${data.links.serial_numbers}" target="_blank">üìä Serial Numbers (FT Tracking)</a>
                <a href="${data.links.odm_export}" target="_blank">üìÅ ODM Export (Google Drive)</a>
                <div class="dropdown">
                    <a href="#" class="dropdown-toggle" onclick="event.preventDefault(); this.parentElement.classList.toggle('open')">üí¨ Slack Internal ‚ñæ</a>
                    <div class="dropdown-menu">
                        <a href="${data.links.slack_eng}" target="_blank">#eng-beam4k</a>
                        <a href="${data.links.slack_general}" target="_blank">#general-beam4k</a>
                    </div>
                </div>
                <div class="dropdown">
                    <a href="#" class="dropdown-toggle" onclick="event.preventDefault(); this.parentElement.classList.toggle('open')">üí¨ Slack External ‚ñæ</a>
                    <div class="dropdown-menu">
                        <a href="https://app.slack.com/client/T08V7G1079N/C090K46SA7P" target="_blank">AONI</a>
                        <a href="https://app.slack.com/client/T0780SDQR5W/C077HGQ1ASF" target="_blank">Chicony</a>
                    </div>
                </div>
                <a href="${data.links.jenkins}" target="_blank">üîß Jenkins (B4 Builds)</a>
                <div class="dropdown">
                    <a href="#" class="dropdown-toggle" onclick="event.preventDefault(); this.parentElement.classList.toggle('open')">üêô GitHub ‚ñæ</a>
                    <div class="dropdown-menu">
                        <a href="${data.links.gh_chicony}" target="_blank">nexar-chicony</a>
                        <a href="${data.links.gh_sdk}" target="_blank">nexar-client-sdk</a>
                        <a href="${data.links.gh_hub}" target="_blank">b4-project-hub</a>
                        <a href="${data.links.gh_my_prs}" target="_blank">üì§ My PRs</a>
                        <a href="${data.links.gh_review_prs}" target="_blank">üëÄ Review Requests</a>
                    </div>
                </div>
            `;
            document.getElementById('links').innerHTML = linksHtml;

            // Bugs table with pagination
            window.bugsData = data.bugs;
            window.bugsPage = 1;
            window.bugsPerPage = 10;
            document.getElementById('bugs-count').textContent = data.bugs.length;
            document.getElementById('bugs-link').href = data.links.br_bugs;
            renderBugsPage();

            // Tickets table with pagination
            window.ticketsData = data.tickets;
            window.ticketsPage = 1;
            window.ticketsPerPage = 10;
            document.getElementById('tickets-count').textContent = data.tickets.length;
            document.getElementById('tickets-link').href = data.links.jira_board;
            renderTicketsPage();

            // Velocity Chart - Cumulative
            if (data.velocity && data.velocity.length > 0) {
                // Store data for fullscreen chart
                window.lastVelocityData = data;

                const ctx = document.getElementById('velocity-chart').getContext('2d');
                // Destroy existing chart if any
                if (window.velocityChart) window.velocityChart.destroy();

                // Calculate cumulative values
                let cumResolved = 0, cumCreated = 0;
                const cumulativeResolved = data.velocity.map(v => { cumResolved += v.resolved; return cumResolved; });
                cumCreated = 0;
                const cumulativeCreated = data.velocity.map(v => { cumCreated += v.created; return cumCreated; });

                // Open bugs at each week (starting from initial_bugs)
                let openBugs = data.initial_bugs || 0;
                const openBugsLine = data.velocity.map(v => {
                    openBugs += (v.bugs_created || 0) - (v.bugs_resolved || 0);
                    return openBugs;
                });

                // Velocity trend line (positive slope showing cumulative at avg rate)
                const totalResolved = data.velocity.reduce((sum, v) => sum + v.resolved, 0);
                const avgVelocity = totalResolved / data.velocity.length;
                const velocityTrendLine = data.velocity.map((v, i) => avgVelocity * (i + 1));

                window.velocityChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.velocity.map(v => v.week),
                        datasets: [
                            {
                                label: 'Open Bugs',
                                data: openBugsLine,
                                borderColor: '#da3633',
                                backgroundColor: 'rgba(218, 54, 51, 0.1)',
                                fill: true,
                                tension: 0.3,
                                borderWidth: 2
                            },
                            {
                                label: `Velocity Trend (${avgVelocity.toFixed(1)}/wk)`,
                                data: velocityTrendLine,
                                borderColor: 'rgba(255, 255, 255, 0.4)',
                                borderDash: [5, 5],
                                backgroundColor: 'transparent',
                                fill: false,
                                tension: 0,
                                borderWidth: 2,
                                pointRadius: 0,
                                datalabels: { display: false }
                            },
                            {
                                label: 'Resolved (cumulative)',
                                data: cumulativeResolved,
                                borderColor: '#238636',
                                backgroundColor: 'rgba(35, 134, 54, 0.1)',
                                fill: true,
                                tension: 0.3
                            },
                            {
                                label: 'Created (cumulative)',
                                data: cumulativeCreated,
                                borderColor: '#1f6feb',
                                backgroundColor: 'rgba(31, 111, 235, 0.1)',
                                fill: true,
                                tension: 0.3
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { reverse: true, labels: { color: '#8b949e' } },
                            datalabels: {
                                display: (ctx) => ctx.dataIndex % 2 === 1,
                                color: '#c9d1d9',
                                font: { size: 10 },
                                anchor: 'end',
                                align: 'top'
                            }
                        },
                        scales: {
                            x: { ticks: { color: '#8b949e' }, grid: { color: '#21262d' } },
                            y: { ticks: { color: '#8b949e' }, grid: { color: '#21262d' }, beginAtZero: true }
                        }
                    },
                    plugins: [ChartDataLabels]
                });
            }

            // Updated timestamp
            const updated = new Date(data.updated);
            document.getElementById('updated').textContent = `Last updated: ${updated.toLocaleString()}`;
        }

        async function refreshData() {
            const btn = document.getElementById('refresh-btn');
            btn.disabled = true;
            btn.classList.add('loading');
            btn.textContent = '‚è≥ Fetching...';

            try {
                // Call the fetch script via a cache-busting reload
                await loadDashboard();
                btn.textContent = '‚úÖ Updated!';
                setTimeout(() => {
                    btn.textContent = 'üîÑ Refresh Data';
                    btn.disabled = false;
                    btn.classList.remove('loading');
                }, 1500);
            } catch (e) {
                btn.textContent = '‚ùå Error';
                setTimeout(() => {
                    btn.textContent = 'üîÑ Refresh Data';
                    btn.disabled = false;
                    btn.classList.remove('loading');
                }, 2000);
            }
        }

        function renderBugsPage() {
            // Apply filter if set
            let filteredData = window.bugsData;
            if (window.bugsFilter) {
                filteredData = window.bugsData.filter(b => b[window.bugsFilter.field] === window.bugsFilter.value);
                document.getElementById('bugs-filter').style.display = 'flex';
                document.getElementById('bugs-filter').innerHTML = `<span>Filtered by:</span> <span class="filter-value">${window.bugsFilter.field} = "${window.bugsFilter.value}"</span> <button onclick="clearBugsFilter()">‚úï Clear</button>`;
            } else {
                document.getElementById('bugs-filter').style.display = 'none';
            }

            const start = (window.bugsPage - 1) * window.bugsPerPage;
            const end = start + window.bugsPerPage;
            const pageData = filteredData.slice(start, end);
            const totalPages = Math.ceil(filteredData.length / window.bugsPerPage) || 1;

            const html = pageData.map(bug => `
                <tr>
                    <td><a class="ticket-link" href="${bug.url}" target="_blank">${bug.key}</a></td>
                    <td class="truncate" title="${bug.summary}">${bug.summary}</td>
                    <td><span class="status-badge status-${bug.status.toLowerCase().replace(' ', '-')} clickable" onclick="filterBugs('status','${bug.status}')">${bug.status}</span></td>
                    <td class="clickable" onclick="filterBugs('assignee','${bug.assignee}')">${bug.assignee}</td>
                    <td class="clickable" onclick="filterBugs('priority','${bug.priority || '-'}')">${bug.priority || '-'}</td>
                    <td class="clickable" onclick="filterBugs('version','${bug.version || '-'}')">${bug.version || '-'}</td>
                </tr>
            `).join('');
            document.getElementById('bugs-body').innerHTML = html || '<tr><td colspan="6">No bugs</td></tr>';

            let paginationHtml = `<button onclick="window.bugsPage=1; renderBugsPage()" ${window.bugsPage === 1 ? 'disabled' : ''}>&laquo;</button>`;
            paginationHtml += `<button onclick="window.bugsPage--; renderBugsPage()" ${window.bugsPage === 1 ? 'disabled' : ''}>&lsaquo; Prev</button>`;
            paginationHtml += `<span class="page-info">${window.bugsPage} / ${totalPages} (${filteredData.length})</span>`;
            paginationHtml += `<button onclick="window.bugsPage++; renderBugsPage()" ${window.bugsPage >= totalPages ? 'disabled' : ''}>Next &rsaquo;</button>`;
            paginationHtml += `<button onclick="window.bugsPage=${totalPages}; renderBugsPage()" ${window.bugsPage >= totalPages ? 'disabled' : ''}>&raquo;</button>`;
            document.getElementById('bugs-pagination').innerHTML = paginationHtml;
        }

        function filterBugs(field, value) {
            window.bugsFilter = { field, value };
            window.bugsPage = 1;
            renderBugsPage();
        }

        function clearBugsFilter() {
            window.bugsFilter = null;
            window.bugsPage = 1;
            renderBugsPage();
        }

        function sortBugs(field) {
            // Toggle sort direction
            if (window.bugsSortField === field) {
                window.bugsSortDir = window.bugsSortDir === 'asc' ? 'desc' : 'asc';
            } else {
                window.bugsSortField = field;
                window.bugsSortDir = 'asc';
            }

            // Sort data
            window.bugsData.sort((a, b) => {
                let valA = (a[field] || '').toString().toLowerCase();
                let valB = (b[field] || '').toString().toLowerCase();
                if (valA < valB) return window.bugsSortDir === 'asc' ? -1 : 1;
                if (valA > valB) return window.bugsSortDir === 'asc' ? 1 : -1;
                return 0;
            });

            // Update sort indicators
            ['key','summary','status','assignee','priority','version'].forEach(f => {
                document.getElementById('bugs-sort-' + f).textContent = '';
            });
            document.getElementById('bugs-sort-' + field).textContent = window.bugsSortDir === 'asc' ? '‚ñ≤' : '‚ñº';

            window.bugsPage = 1;
            renderBugsPage();
        }

        function renderTicketsPage() {
            // Apply filter if set
            let filteredData = window.ticketsData;
            if (window.ticketsFilter) {
                filteredData = window.ticketsData.filter(t => t[window.ticketsFilter.field] === window.ticketsFilter.value);
                document.getElementById('tickets-filter').style.display = 'flex';
                document.getElementById('tickets-filter').innerHTML = `<span>Filtered by:</span> <span class="filter-value">${window.ticketsFilter.field} = "${window.ticketsFilter.value}"</span> <button onclick="clearTicketsFilter()">‚úï Clear</button>`;
            } else {
                document.getElementById('tickets-filter').style.display = 'none';
            }

            const start = (window.ticketsPage - 1) * window.ticketsPerPage;
            const end = start + window.ticketsPerPage;
            const pageData = filteredData.slice(start, end);
            const totalPages = Math.ceil(filteredData.length / window.ticketsPerPage) || 1;

            const html = pageData.map(t => `
                <tr>
                    <td><a class="ticket-link" href="${t.url}" target="_blank">${t.key}</a></td>
                    <td class="truncate" title="${t.summary}">${t.summary}</td>
                    <td><span class="status-badge status-${t.status.toLowerCase().replace(' ', '-')} clickable" onclick="filterTickets('status','${t.status}')">${t.status}</span></td>
                    <td class="clickable" onclick="filterTickets('assignee','${t.assignee}')">${t.assignee}</td>
                    <td class="clickable" onclick="filterTickets('priority','${t.priority || '-'}')">${t.priority || '-'}</td>
                    <td class="clickable" onclick="filterTickets('version','${t.version || '-'}')">${t.version || '-'}</td>
                </tr>
            `).join('');
            document.getElementById('tickets-body').innerHTML = html || '<tr><td colspan="6">No tickets</td></tr>';

            // Pagination controls
            let paginationHtml = `<button onclick="window.ticketsPage=1; renderTicketsPage()" ${window.ticketsPage === 1 ? 'disabled' : ''}>&laquo;</button>`;
            paginationHtml += `<button onclick="window.ticketsPage--; renderTicketsPage()" ${window.ticketsPage === 1 ? 'disabled' : ''}>&lsaquo; Prev</button>`;
            paginationHtml += `<span class="page-info">${window.ticketsPage} / ${totalPages} (${filteredData.length})</span>`;
            paginationHtml += `<button onclick="window.ticketsPage++; renderTicketsPage()" ${window.ticketsPage >= totalPages ? 'disabled' : ''}>Next &rsaquo;</button>`;
            paginationHtml += `<button onclick="window.ticketsPage=${totalPages}; renderTicketsPage()" ${window.ticketsPage >= totalPages ? 'disabled' : ''}>&raquo;</button>`;
            document.getElementById('tickets-pagination').innerHTML = paginationHtml;
        }

        function filterTickets(field, value) {
            window.ticketsFilter = { field, value };
            window.ticketsPage = 1;
            renderTicketsPage();
        }

        function clearTicketsFilter() {
            window.ticketsFilter = null;
            window.ticketsPage = 1;
            renderTicketsPage();
        }

        function openChartFullscreen() {
            document.getElementById('chart-fullscreen').style.display = 'block';
            document.body.style.overflow = 'hidden';
            renderFullscreenChart();
        }

        function closeChartFullscreen() {
            document.getElementById('chart-fullscreen').style.display = 'none';
            document.body.style.overflow = '';
            if (window.velocityChartFull) {
                window.velocityChartFull.destroy();
                window.velocityChartFull = null;
            }
        }

        function renderFullscreenChart() {
            if (!window.lastVelocityData) return;
            const data = window.lastVelocityData;
            const ctx = document.getElementById('velocity-chart-full').getContext('2d');

            if (window.velocityChartFull) window.velocityChartFull.destroy();

            // Same chart config as main chart
            let cumResolved = 0, cumCreated = 0;
            const cumulativeResolved = data.velocity.map(v => { cumResolved += v.resolved; return cumResolved; });
            const cumulativeCreated = data.velocity.map(v => { cumCreated += v.created; return cumCreated; });

            let openBugs = data.initial_bugs || 0;
            const openBugsLine = data.velocity.map(v => {
                openBugs += (v.bugs_created || 0) - (v.bugs_resolved || 0);
                return openBugs;
            });

            const totalResolved = data.velocity.reduce((sum, v) => sum + v.resolved, 0);
            const avgVelocity = totalResolved / data.velocity.length;
            const velocityTrendLine = data.velocity.map((v, i) => avgVelocity * (i + 1));

            window.velocityChartFull = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.velocity.map(v => v.week),
                    datasets: [
                        { label: 'Open Bugs', data: openBugsLine, borderColor: '#da3633', backgroundColor: 'rgba(218, 54, 51, 0.1)', fill: true, tension: 0.3, borderWidth: 3 },
                        { label: `Velocity Trend (${avgVelocity.toFixed(1)}/wk)`, data: velocityTrendLine, borderColor: 'rgba(255, 255, 255, 0.4)', borderDash: [5, 5], backgroundColor: 'transparent', fill: false, tension: 0, borderWidth: 2, pointRadius: 0, datalabels: { display: false } },
                        { label: 'Resolved (cumulative)', data: cumulativeResolved, borderColor: '#238636', backgroundColor: 'rgba(35, 134, 54, 0.1)', fill: true, tension: 0.3, borderWidth: 3 },
                        { label: 'Created (cumulative)', data: cumulativeCreated, borderColor: '#1f6feb', backgroundColor: 'rgba(31, 111, 235, 0.1)', fill: true, tension: 0.3, borderWidth: 3 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { reverse: true, labels: { color: '#c9d1d9', font: { size: 14 } } },
                        datalabels: { display: (ctx) => ctx.dataIndex % 2 === 1, color: '#c9d1d9', font: { size: 12 }, anchor: 'end', align: 'top' }
                    },
                    scales: {
                        x: { ticks: { color: '#c9d1d9', font: { size: 14 } }, grid: { color: '#21262d' } },
                        y: { ticks: { color: '#c9d1d9', font: { size: 14 } }, grid: { color: '#21262d' }, beginAtZero: true }
                    }
                },
                plugins: [ChartDataLabels]
            });
        }

        // Handle Escape key to close fullscreen
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeChartFullscreen();
        });

        function sortTickets(field) {
            // Toggle sort direction
            if (window.ticketsSortField === field) {
                window.ticketsSortDir = window.ticketsSortDir === 'asc' ? 'desc' : 'asc';
            } else {
                window.ticketsSortField = field;
                window.ticketsSortDir = 'asc';
            }

            // Sort data
            window.ticketsData.sort((a, b) => {
                let valA = (a[field] || '').toString().toLowerCase();
                let valB = (b[field] || '').toString().toLowerCase();
                if (valA < valB) return window.ticketsSortDir === 'asc' ? -1 : 1;
                if (valA > valB) return window.ticketsSortDir === 'asc' ? 1 : -1;
                return 0;
            });

            // Update sort indicators
            ['key','summary','status','assignee','priority','version'].forEach(f => {
                document.getElementById('tickets-sort-' + f).textContent = '';
            });
            document.getElementById('tickets-sort-' + field).textContent = window.ticketsSortDir === 'asc' ? '‚ñ≤' : '‚ñº';

            window.ticketsPage = 1;
            renderTicketsPage();
        }

        loadDashboard();
        // Auto-refresh every 5 minutes
        setInterval(loadDashboard, 300000);
    </script>
</body>
</html>
