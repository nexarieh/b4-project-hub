<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B4 Project Dashboard</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0d1117;
            color: #c9d1d9;
            padding: 20px;
            line-height: 1.5;
        }
        .container { max-width: 1600px; margin: 0 auto; }
        h1 { color: #58a6ff; margin-bottom: 5px; }
        .subtitle { color: #8b949e; margin-bottom: 20px; }
        .main-layout { display: grid; grid-template-columns: 220px 1fr; gap: 20px; }
        .sidebar { height: fit-content; }
        .content-area { display: flex; flex-direction: column; gap: 20px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
        @media (max-width: 1200px) { .main-layout { grid-template-columns: 1fr; } .grid-3 { grid-template-columns: 1fr; } }
        .card {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 16px;
        }
        .card h2 {
            color: #58a6ff;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #30363d;
        }
        .status-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        .status-done { background: #238636; color: #fff; }
        .status-in_progress, .status-progress { background: #1f6feb; color: #fff; }
        .status-blocked { background: #da3633; color: #fff; }
        .status-backlog { background: #30363d; color: #8b949e; }
        .status-new, .status-todo { background: #6e7681; color: #fff; }

        .milestone-list { display: flex; flex-wrap: wrap; gap: 8px; }
        .milestone-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: #21262d;
            border-radius: 6px;
            font-size: 13px;
        }
        .milestone-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        .dot-done { background: #238636; }
        .dot-in_progress { background: #1f6feb; }
        .dot-blocked { background: #da3633; }
        .dot-backlog { background: #484f58; }

        .priority-list { list-style: none; }
        .priority-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #21262d;
        }
        .priority-item:last-child { border-bottom: none; }
        .priority-num {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 22px;
            height: 22px;
            background: #da3633;
            color: #fff;
            border-radius: 50%;
            font-size: 12px;
            font-weight: bold;
            margin-right: 10px;
        }
        .priority-ticket {
            color: #58a6ff;
            text-decoration: none;
            font-family: monospace;
        }
        .priority-ticket:hover { text-decoration: underline; }

        .metrics-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .metric-box {
            background: #21262d;
            padding: 12px;
            border-radius: 6px;
            text-align: center;
        }
        .metric-value { font-size: 28px; font-weight: bold; color: #58a6ff; }
        .metric-label { font-size: 12px; color: #8b949e; }

        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { text-align: left; color: #8b949e; font-weight: 500; padding: 8px 6px; border-bottom: 1px solid #30363d; }
        td { padding: 8px 6px; border-bottom: 1px solid #21262d; }
        tr:hover { background: #21262d; }
        .ticket-link { color: #58a6ff; text-decoration: none; font-family: monospace; }
        .ticket-link:hover { text-decoration: underline; }
        .truncate { max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        .links-list a {
            display: block;
            color: #58a6ff;
            text-decoration: none;
            padding: 8px 0;
            border-bottom: 1px solid #21262d;
        }
        .links-list a:hover { background: #21262d; margin: 0 -16px; padding: 8px 16px; }
        .links-list a:last-child { border-bottom: none; }

        .links-list .dropdown { position: relative; border-bottom: 1px solid #21262d; }
        .links-list .dropdown-toggle {
            display: block;
            color: #58a6ff;
            text-decoration: none;
            padding: 8px 0;
            cursor: pointer;
        }
        .links-list .dropdown-toggle:hover { background: #21262d; margin: 0 -16px; padding: 8px 16px; }
        .links-list .dropdown-menu {
            display: none;
            padding-left: 16px;
            background: #21262d;
            margin: 0 -16px;
            padding: 4px 16px 8px;
        }
        .links-list .dropdown.open .dropdown-menu { display: block; }
        .links-list .dropdown-menu a {
            padding: 6px 0;
            font-size: 13px;
            border-bottom: none;
        }
        .links-list .dropdown-menu a:hover { background: #30363d; margin: 0 -8px; padding: 6px 8px; border-radius: 4px; }

        .status-bar { display: flex; height: 8px; border-radius: 4px; overflow: hidden; margin-top: 8px; }
        .status-segment { height: 100%; }

        .updated { text-align: right; color: #484f58; font-size: 12px; margin-top: 20px; }
        .error { color: #f85149; padding: 20px; text-align: center; }

        .full-width { grid-column: 1 / -1; }
        .scroll-table { max-height: 300px; overflow-y: auto; }

        .pagination {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #21262d;
        }
        .pagination button {
            background: #21262d;
            border: 1px solid #30363d;
            color: #c9d1d9;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
        }
        .pagination button:hover { background: #30363d; }
        .pagination button:disabled { opacity: 0.5; cursor: not-allowed; }
        .pagination button.active { background: #1f6feb; border-color: #1f6feb; }
        .pagination .page-info { color: #8b949e; font-size: 13px; line-height: 32px; }

        .filter-bar {
            background: #21262d;
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .filter-bar span { color: #8b949e; }
        .filter-bar .filter-value { color: #58a6ff; font-weight: 500; }
        .filter-bar button {
            background: #da3633;
            border: none;
            color: #fff;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .filter-presets { display: flex; gap: 6px; flex-wrap: wrap; }
        .preset-btn {
            background: #21262d;
            border: 1px solid #30363d;
            color: #8b949e;
            padding: 4px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.15s;
        }
        .preset-btn:hover { background: #30363d; color: #c9d1d9; border-color: #58a6ff; }
        .preset-btn.active { background: #1f6feb; color: #fff; border-color: #1f6feb; }
        .clickable { cursor: pointer; }
        .clickable:hover { text-decoration: underline; }
        .sortable { cursor: pointer; user-select: none; }
        .sortable:hover { background: #30363d; }

        .chart-fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #0d1117;
            z-index: 1000;
            padding: 20px;
            box-sizing: border-box;
        }
        .chart-fullscreen .close-btn {
            position: absolute;
            top: 20px;
            right: 30px;
            background: #da3633;
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            z-index: 1001;
        }
        .chart-fullscreen .close-btn:hover { background: #f85149; }
        .chart-fullscreen h2 { color: #58a6ff; margin-bottom: 20px; }
        .chart-container { cursor: pointer; }
        .chart-container:hover { opacity: 0.9; }

        #refresh-btn {
            background: #238636;
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.2s;
        }
        #refresh-btn:hover { background: #2ea043; }
        #refresh-btn:disabled { background: #484f58; cursor: wait; }
        #refresh-btn.loading { animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
    </style>
</head>
<body>
    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h1>üöó B4 Project Dashboard</h1>
                <p class="subtitle" id="project-phase">Loading...</p>
            </div>
            <div style="display: flex; gap: 10px; align-items: center;">
                <div style="position:relative;">
                    <input type="text" id="global-search" placeholder="Search bugs & tickets..." oninput="globalSearch(this.value)" onkeydown="handleSearchKey(event)" style="width:220px;padding:10px 12px;background:#21262d;border:1px solid #30363d;border-radius:6px;color:#c9d1d9;font-size:14px;">
                    <div id="search-results" style="display:none;position:absolute;top:100%;left:0;right:0;background:#161b22;border:1px solid #30363d;border-radius:0 0 6px 6px;max-height:300px;overflow-y:auto;z-index:100;"></div>
                </div>
                <button onclick="exportToCSV()" style="background:#6e7681;color:#fff;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;font-size:14px;font-weight:500;">üì• Export</button>
                <button onclick="showSummaryView()" style="background:#6e7681;color:#fff;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;font-size:14px;font-weight:500;">üìä Summary</button>
                <button onclick="copyShareableLink()" style="background:#6e7681;color:#fff;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;font-size:14px;font-weight:500;">üîó Share</button>
                <a id="sprint-btn" href="#" target="_blank" style="background:#1f6feb;color:#fff;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;font-size:14px;font-weight:500;text-decoration:none;display:inline-block;">üóìÔ∏è Current Sprint</a>
                <button id="refresh-btn" onclick="refreshData()">üîÑ Refresh Data</button>
            </div>
        </div>

        <div class="main-layout">
            <!-- Left Sidebar - Quick Links -->
            <div class="sidebar">
                <div class="card">
                    <h2>üîó Quick Links</h2>
                    <div class="links-list" id="links">Loading...</div>
                </div>
            </div>

            <!-- Main Content Area -->
            <div class="content-area">
                <!-- Top Row: Releases (wide) + Milestones -->
                <div class="grid" style="grid-template-columns: 2fr 1fr;">
                    <!-- Releases -->
                    <div class="card">
                        <h2><a href="https://getnexar.atlassian.net/projects/FS?selectedItem=com.atlassian.jira.jira-projects-plugin%3Arelease-page&status=no-filter" target="_blank" style="color: inherit; text-decoration: none;">üöÄ Releases ‚Üó</a></h2>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div>
                                <h3 style="color: #8b949e; font-size: 12px; margin-bottom: 8px;">FW Releases</h3>
                                <div class="scroll-table" style="max-height: 200px;">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>Version</th>
                                                <th>Status</th>
                                                <th>Date</th>
                                            </tr>
                                        </thead>
                                        <tbody id="fw-releases-body">Loading...</tbody>
                                    </table>
                                </div>
                            </div>
                            <div>
                                <h3 style="color: #8b949e; font-size: 12px; margin-bottom: 8px;">MCU Releases</h3>
                                <div>
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>Version</th>
                                                <th>Status</th>
                                                <th>Date</th>
                                            </tr>
                                        </thead>
                                        <tbody id="mcu-releases-body">Loading...</tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Milestones -->
                    <div class="card">
                        <h2>üìç Milestones</h2>
                        <div class="scroll-table" style="max-height: 200px;">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Milestone</th>
                                        <th>Status</th>
                                        <th>Date</th>
                                    </tr>
                                </thead>
                                <tbody id="milestones">Loading...</tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Second Row: Priorities + Metrics -->
                <div class="grid">
                    <!-- Top Priorities -->
                    <div class="card">
                        <h2>üéØ Top 5 Priorities</h2>
                        <ul class="priority-list" id="priorities">Loading...</ul>
                    </div>

                    <!-- Metrics -->
                    <div class="card">
                        <h2>üìä Metrics</h2>
                        <div class="metrics-grid" id="metrics">Loading...</div>
                    </div>
                </div>

            </div>

            <!-- Velocity Chart (full width) -->
            <div class="card" style="margin-top: 20px; grid-column: 1 / -1;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #30363d;">
                    <h2 style="margin: 0; border: none; padding: 0;">üìà Velocity (Story Points) <span id="velocity-title">(Last 8 Weeks)</span></h2>
                    <div style="display: flex; gap: 8px;">
                        <button id="sprint-velocity-btn" onclick="toggleSprintView()" style="background:#1f6feb;color:#fff;border:none;padding:6px 12px;border-radius:4px;cursor:pointer;font-size:12px;">üìÖ Sprint View</button>
                        <button id="b4-filter-btn" onclick="toggleB4Filter()" style="background:#238636;color:#fff;border:none;padding:6px 12px;border-radius:4px;cursor:pointer;font-size:12px;">üè∑Ô∏è B4 Only</button>
                        <button onclick="openChartFullscreen()" style="background:#30363d;color:#c9d1d9;border:none;padding:6px 12px;border-radius:4px;cursor:pointer;font-size:12px;">‚õ∂ Expand</button>
                    </div>
                </div>
                <div class="chart-container" style="height: 280px;" onclick="if(event.target.tagName !== 'BUTTON') openChartFullscreen()">
                    <canvas id="velocity-chart"></canvas>
                </div>
                <!-- Sprint Issues Table (hidden by default) -->
                <div id="sprint-issues-container" style="display: none; margin-top: 16px;">
                    <h3 style="color: #8b949e; font-size: 13px; margin-bottom: 8px;">Sprint Issues (<span id="sprint-issues-count">0</span>)</h3>
                    <div class="scroll-table" style="max-height: 300px;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Key</th>
                                    <th>Summary</th>
                                    <th>Type</th>
                                    <th>Status</th>
                                    <th>SP</th>
                                </tr>
                            </thead>
                            <tbody id="sprint-issues-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Fullscreen Chart Overlay -->
            <div id="chart-fullscreen" class="chart-fullscreen" style="display: none;">
                <button class="close-btn" onclick="closeChartFullscreen()">‚úï Close</button>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h2 id="fullscreen-title" style="margin: 0;">üìà Velocity (Story Points) (Last 8 Weeks)</h2>
                    <div style="display: flex; gap: 10px; margin-right: 120px;">
                        <button id="fullscreen-sprint-btn" onclick="toggleFullscreenView()" style="background:#1f6feb;color:#fff;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;font-size:14px;">üìÖ Sprint View</button>
                        <button id="fullscreen-b4-btn" onclick="toggleFullscreenB4Filter()" style="background:#238636;color:#fff;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;font-size:14px;">üè∑Ô∏è B4 Only</button>
                    </div>
                </div>
                <div style="height: calc(100vh - 120px);">
                    <canvas id="velocity-chart-full"></canvas>
                </div>
            </div>

            <!-- Bug Aging Analysis -->
            <div class="card" style="margin-top: 20px; grid-column: 1 / -1;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #30363d;">
                    <h2 style="margin: 0; border: none; padding: 0;">üîç Bug Aging Analysis</h2>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
                    <div>
                        <div class="chart-container" style="height: 180px;">
                            <canvas id="bug-aging-chart"></canvas>
                        </div>
                    </div>
                    <div>
                        <div class="metric-box" style="margin-bottom: 12px;">
                            <div class="metric-value" id="avg-bug-age">-</div>
                            <div class="metric-label">Avg Bug Age (days)</div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-value" id="bug-forecast">-</div>
                            <div class="metric-label">Bug Backlog Trend</div>
                        </div>
                    </div>
                    <div>
                        <div style="color: #8b949e; font-size: 12px; margin-bottom: 8px; text-transform: uppercase;">Oldest Bugs</div>
                        <div id="oldest-bugs-list" style="font-size: 13px;"></div>
                    </div>
                </div>
            </div>

            <!-- Team Metrics -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; grid-column: 1 / -1;">
                <!-- Team Velocity -->
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #30363d;">
                        <h2 style="margin: 0; border: none; padding: 0;">üë• Team Velocity - Story Points (8 weeks)</h2>
                    </div>
                    <div class="chart-container" style="height: 320px;">
                        <canvas id="team-velocity-chart"></canvas>
                    </div>
                </div>

                <!-- Workload Balance -->
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #30363d;">
                        <h2 style="margin: 0; border: none; padding: 0;">‚öñÔ∏è Current Workload (SP)</h2>
                    </div>
                    <div class="chart-container" style="height: 320px;">
                        <canvas id="workload-chart"></canvas>
                    </div>
                </div>
            </div>

            <div class="content-area" style="margin-top: 0; grid-column: 1 / -1;">

                <!-- BR Bugs (full width) -->
                <div class="card">
                    <h2><a id="bugs-link" href="#" target="_blank" style="color: inherit; text-decoration: none;">üêõ BR Bugs (<span id="bugs-count">0</span>) ‚Üó</a></h2>
                    <div class="filter-presets" style="margin-bottom: 8px;">
                        <button onclick="applyBugsPreset('critical')" class="preset-btn">Critical (>30d)</button>
                        <button onclick="applyBugsPreset('unassigned')" class="preset-btn">Unassigned</button>
                        <button onclick="applyBugsPreset('in_progress')" class="preset-btn">In Progress</button>
                        <button onclick="applyBugsPreset('high_priority')" class="preset-btn">High Priority</button>
                        <button onclick="clearBugsFilter()" class="preset-btn" style="background:#30363d;">All</button>
                    </div>
                    <div id="bugs-filter" class="filter-bar" style="display:none;"></div>
                    <table id="bugs-table" style="width: 100%;">
                        <thead>
                            <tr>
                                <th class="sortable" onclick="sortBugs('key')">Key <span id="bugs-sort-key"></span></th>
                                <th class="sortable" onclick="sortBugs('summary')">Summary <span id="bugs-sort-summary"></span></th>
                                <th class="sortable" onclick="sortBugs('status')">Status <span id="bugs-sort-status"></span></th>
                                <th class="sortable" onclick="sortBugs('assignee')">Assignee <span id="bugs-sort-assignee"></span></th>
                                <th class="sortable" onclick="sortBugs('priority')">Priority <span id="bugs-sort-priority"></span></th>
                                <th class="sortable" onclick="sortBugs('version')">Version <span id="bugs-sort-version"></span></th>
                                <th class="sortable" onclick="sortBugs('story_points')">SP <span id="bugs-sort-story_points"></span></th>
                                <th class="sortable" onclick="sortBugs('age')">Age <span id="bugs-sort-age"></span></th>
                            </tr>
                        </thead>
                        <tbody id="bugs-body">Loading...</tbody>
                    </table>
                    <div class="pagination" id="bugs-pagination"></div>
                </div>

                <!-- FS Tickets (full width) -->
                <div class="card">
                    <h2><a id="tickets-link" href="#" target="_blank" style="color: inherit; text-decoration: none;">üìã FS Tickets (<span id="tickets-count">0</span>) ‚Üó</a></h2>
                    <div class="filter-presets" style="margin-bottom: 8px;">
                        <button onclick="applyTicketsPreset('unassigned')" class="preset-btn">Unassigned</button>
                        <button onclick="applyTicketsPreset('in_progress')" class="preset-btn">In Progress</button>
                        <button onclick="applyTicketsPreset('high_priority')" class="preset-btn">High Priority</button>
                        <button onclick="applyTicketsPreset('todo')" class="preset-btn">To Do</button>
                        <button onclick="clearTicketsFilter()" class="preset-btn" style="background:#30363d;">All</button>
                    </div>
                    <div id="tickets-filter" class="filter-bar" style="display:none;"></div>
                    <table id="tickets-table" style="width: 100%;">
                        <thead>
                            <tr>
                                <th class="sortable" onclick="sortTickets('key')">Key <span id="tickets-sort-key"></span></th>
                                <th class="sortable" onclick="sortTickets('summary')">Summary <span id="tickets-sort-summary"></span></th>
                                <th class="sortable" onclick="sortTickets('status')">Status <span id="tickets-sort-status"></span></th>
                                <th class="sortable" onclick="sortTickets('assignee')">Assignee <span id="tickets-sort-assignee"></span></th>
                                <th class="sortable" onclick="sortTickets('priority')">Priority <span id="tickets-sort-priority"></span></th>
                                <th class="sortable" onclick="sortTickets('version')">Version <span id="tickets-sort-version"></span></th>
                                <th class="sortable" onclick="sortTickets('story_points')">SP <span id="tickets-sort-story_points"></span></th>
                            </tr>
                        </thead>
                        <tbody id="tickets-body">Loading...</tbody>
                    </table>
                    <div class="pagination" id="tickets-pagination"></div>
                </div>

                <!-- FT Field Test (full width) -->
                <div class="card">
                    <h2><a id="ft-link" href="#" target="_blank" style="color: inherit; text-decoration: none;">üß™ FT Field Test (<span id="ft-count">0</span>) ‚Üó</a></h2>
                    <div class="filter-presets" style="margin-bottom: 8px;">
                        <button onclick="applyFtPreset('unassigned')" class="preset-btn">Unassigned</button>
                        <button onclick="applyFtPreset('in_progress')" class="preset-btn">In Progress</button>
                        <button onclick="applyFtPreset('high_priority')" class="preset-btn">High Priority</button>
                        <button onclick="clearFtFilter()" class="preset-btn" style="background:#30363d;">All</button>
                    </div>
                    <div id="ft-filter" class="filter-bar" style="display:none;"></div>
                    <table id="ft-table" style="width: 100%;">
                        <thead>
                            <tr>
                                <th class="sortable" onclick="sortFt('key')">Key <span id="ft-sort-key"></span></th>
                                <th class="sortable" onclick="sortFt('summary')">Summary <span id="ft-sort-summary"></span></th>
                                <th class="sortable" onclick="sortFt('status')">Status <span id="ft-sort-status"></span></th>
                                <th class="sortable" onclick="sortFt('assignee')">Assignee <span id="ft-sort-assignee"></span></th>
                                <th class="sortable" onclick="sortFt('priority')">Priority <span id="ft-sort-priority"></span></th>
                                <th class="sortable" onclick="sortFt('story_points')">SP <span id="ft-sort-story_points"></span></th>
                                <th class="sortable" onclick="sortFt('age')">Age <span id="ft-sort-age"></span></th>
                            </tr>
                        </thead>
                        <tbody id="ft-body">Loading...</tbody>
                    </table>
                    <div class="pagination" id="ft-pagination"></div>
                </div>
            </div>
        </div>

        <p class="updated" id="updated"></p>
    </div>

    <!-- Summary View Overlay -->
    <div id="summary-overlay" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:#ffffff;color:#000000;padding:40px;z-index:2000;overflow-y:auto;">
        <button onclick="closeSummaryView()" style="position:absolute;top:20px;right:20px;background:#da3633;color:#fff;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;font-size:14px;">‚úï Close</button>
        <div id="summary-content"></div>
    </div>

    <script>
        async function loadDashboard(skipRefresh = false) {
            try {
                // Auto-refresh from JIRA on page load (unless skipRefresh is true)
                if (!skipRefresh) {
                    showLoadingIndicator('Fetching from JIRA...');
                    try {
                        await fetch('/api/refresh');
                    } catch (e) {
                        console.log('Auto-refresh failed, using cached data');
                    }
                    hideLoadingIndicator();
                }

                const response = await fetch('data/dashboard.json?t=' + Date.now());
                if (!response.ok) throw new Error('Data not found. Run: python3 fetch_data.py');
                const data = await response.json();

                // Load filter state from URL before rendering
                loadStateFromUrl();

                renderDashboard(data);
            } catch (error) {
                hideLoadingIndicator();
                document.querySelector('.grid').innerHTML = `
                    <div class="card full-width">
                        <div class="error">
                            <h2>‚ö†Ô∏è Could not load data</h2>
                            <p>${error.message}</p>
                            <p style="margin-top: 10px; color: #8b949e;">Run: <code>python3 fetch_data.py</code> first</p>
                        </div>
                    </div>
                `;
            }
        }

        function showLoadingIndicator(message = 'Loading...') {
            let indicator = document.getElementById('loading-indicator');
            if (!indicator) {
                indicator = document.createElement('div');
                indicator.id = 'loading-indicator';
                indicator.style.cssText = 'position:fixed;top:0;left:0;right:0;background:#1f6feb;color:#fff;text-align:center;padding:8px;font-size:14px;z-index:9999;';
                document.body.prepend(indicator);
            }
            indicator.textContent = message;
            indicator.style.display = 'block';
        }

        function hideLoadingIndicator() {
            const indicator = document.getElementById('loading-indicator');
            if (indicator) indicator.style.display = 'none';
        }

        function calculateBugAge(createdDate) {
            if (!createdDate) return 0;
            const created = new Date(createdDate);
            const now = new Date();
            return Math.floor((now - created) / (1000 * 60 * 60 * 24));
        }

        function getAgeStyle(age) {
            if (age > 30) return 'color: #da3633; font-weight: bold;';
            if (age > 14) return 'color: #d29922;';
            return 'color: #8b949e;';
        }

        function renderBugAgingChart(bugs, velocityData) {
            const ageBuckets = { '<7d': 0, '7-14d': 0, '14-30d': 0, '>30d': 0 };
            const bugAges = [];

            bugs.forEach(bug => {
                const age = calculateBugAge(bug.created);
                bugAges.push({ ...bug, age });
                if (age < 7) ageBuckets['<7d']++;
                else if (age < 14) ageBuckets['7-14d']++;
                else if (age < 30) ageBuckets['14-30d']++;
                else ageBuckets['>30d']++;
            });

            window.bugAges = bugAges;

            // Calculate and display average age
            const avgAge = bugAges.length > 0
                ? Math.round(bugAges.reduce((sum, b) => sum + b.age, 0) / bugAges.length)
                : 0;
            document.getElementById('avg-bug-age').textContent = avgAge;

            // Bug closure forecast
            if (velocityData && velocityData.length > 0) {
                const avgBugClosure = velocityData.reduce((sum, v) => sum + (v.bugs_resolved || 0), 0) / velocityData.length;
                const avgBugCreation = velocityData.reduce((sum, v) => sum + (v.bugs_created || 0), 0) / velocityData.length;
                const netClosure = avgBugClosure - avgBugCreation;

                if (netClosure <= 0) {
                    const growthRate = Math.abs(netClosure).toFixed(1);
                    document.getElementById('bug-forecast').innerHTML = `<span style="color:#da3633">+${growthRate}/wk</span>`;
                } else {
                    const weeksToZero = Math.ceil(bugs.length / netClosure);
                    document.getElementById('bug-forecast').innerHTML = `<span style="color:#238636">~${weeksToZero} wks</span>`;
                }
            }

            // Show oldest bugs list
            const oldest = [...bugAges].sort((a, b) => b.age - a.age).slice(0, 4);
            document.getElementById('oldest-bugs-list').innerHTML = oldest.map(b => `
                <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #21262d;">
                    <a href="${b.url}" target="_blank" class="ticket-link">${b.key}</a>
                    <span style="${getAgeStyle(b.age)}">${b.age}d</span>
                </div>
            `).join('');

            // Create horizontal bar chart
            const ctx = document.getElementById('bug-aging-chart').getContext('2d');
            if (window.bugAgingChart) window.bugAgingChart.destroy();

            window.bugAgingChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(ageBuckets),
                    datasets: [{
                        data: Object.values(ageBuckets),
                        backgroundColor: ['#238636', '#1f6feb', '#d29922', '#da3633'],
                        borderRadius: 4
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        datalabels: {
                            display: true,
                            color: '#c9d1d9',
                            anchor: 'end',
                            align: 'right',
                            font: { weight: 'bold' }
                        }
                    },
                    scales: {
                        x: { ticks: { color: '#8b949e' }, grid: { color: '#21262d' } },
                        y: { ticks: { color: '#c9d1d9' }, grid: { display: false } }
                    },
                    onClick: (e, elements) => {
                        if (elements.length > 0) {
                            const bucketName = Object.keys(ageBuckets)[elements[0].index];
                            filterBugsByAge(bucketName);
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
        }

        function renderTeamVelocityChart(teamVelocity) {
            if (!teamVelocity || !teamVelocity.data || Object.keys(teamVelocity.data).length === 0) {
                document.getElementById('team-velocity-chart').parentElement.innerHTML = '<div style="color: #8b949e; text-align: center; padding: 40px;">No team velocity data</div>';
                return;
            }

            const ctx = document.getElementById('team-velocity-chart').getContext('2d');
            if (window.teamVelocityChart) window.teamVelocityChart.destroy();

            const weeks = teamVelocity.weeks;
            const members = Object.keys(teamVelocity.data).sort((a, b) =>
                teamVelocity.data[b].total - teamVelocity.data[a].total
            );

            // Colors for team members
            const colors = ['#238636', '#1f6feb', '#d29922', '#da3633', '#8957e5', '#3fb950', '#58a6ff', '#f85149'];

            const datasets = members.map((member, idx) => ({
                label: member.split(' ')[0], // First name only
                data: weeks.map(w => teamVelocity.data[member].weeks[w] || 0),
                backgroundColor: colors[idx % colors.length],
                borderRadius: 2
            }));

            window.teamVelocityChart = new Chart(ctx, {
                type: 'bar',
                data: { labels: weeks, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { stacked: true, ticks: { color: '#8b949e' }, grid: { display: false } },
                        y: { stacked: true, ticks: { color: '#8b949e' }, grid: { color: '#21262d' } }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#8b949e', boxWidth: 12, padding: 8, font: { size: 10 } }
                        },
                        datalabels: { display: false }
                    }
                },
                plugins: [ChartDataLabels]
            });
        }

        function renderWorkloadChart(workload) {
            if (!workload || Object.keys(workload).length === 0) {
                document.getElementById('workload-chart').parentElement.innerHTML = '<div style="color: #8b949e; text-align: center; padding: 40px;">No workload data</div>';
                return;
            }

            const ctx = document.getElementById('workload-chart').getContext('2d');
            if (window.workloadChart) window.workloadChart.destroy();

            // Sort by total work descending (show all members)
            const members = Object.keys(workload).sort((a, b) => {
                const totalA = workload[a].in_progress + workload[a].todo;
                const totalB = workload[b].in_progress + workload[b].todo;
                return totalB - totalA;
            });

            const labels = members.map(m => m.split(' ')[0]); // First name

            window.workloadChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [
                        {
                            label: 'In Progress (SP)',
                            data: members.map(m => workload[m].in_progress),
                            backgroundColor: '#238636',
                            borderRadius: 2
                        },
                        {
                            label: 'To Do (SP)',
                            data: members.map(m => workload[m].todo),
                            backgroundColor: '#1f6feb',
                            borderRadius: 2
                        }
                    ]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { stacked: true, ticks: { color: '#8b949e' }, grid: { color: '#21262d' } },
                        y: { stacked: true, ticks: { color: '#c9d1d9' }, grid: { display: false } }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#8b949e', boxWidth: 12, padding: 8, font: { size: 10 } }
                        },
                        datalabels: { display: false }
                    }
                },
                plugins: [ChartDataLabels]
            });
        }

        function exportToCSV() {
            const bugs = window.bugsData || [];
            const tickets = window.ticketsData || [];
            const ftTickets = window.ftData || [];
            const dateStr = new Date().toISOString().split('T')[0];

            let csv = 'Type,Key,Summary,Status,Priority,Assignee,Version,Age (days)\n';

            bugs.forEach(b => {
                const age = calculateBugAge(b.created);
                const summary = (b.summary || '').replace(/"/g, '""').replace(/,/g, ' ');
                csv += `Bug,"${b.key}","${summary}","${b.status}","${b.priority || '-'}","${b.assignee}","${b.version || '-'}",${age}\n`;
            });

            tickets.forEach(t => {
                const summary = (t.summary || '').replace(/"/g, '""').replace(/,/g, ' ');
                csv += `Ticket,"${t.key}","${summary}","${t.status}","${t.priority || '-'}","${t.assignee}","${t.version || '-'}",-\n`;
            });

            ftTickets.forEach(t => {
                const age = calculateBugAge(t.created);
                const summary = (t.summary || '').replace(/"/g, '""').replace(/,/g, ' ');
                csv += `FT,"${t.key}","${summary}","${t.status}","${t.priority || '-'}","${t.assignee}","-",${age}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `b4-dashboard-${dateStr}.csv`;
            link.click();
            URL.revokeObjectURL(url);
        }

        function showSummaryView() {
            const data = window.lastVelocityData;
            if (!data) return;

            const bugs = window.bugsData || [];
            const tickets = window.ticketsData || [];
            const ftTickets = window.ftData || [];
            const avgAge = document.getElementById('avg-bug-age')?.textContent || '-';

            // Calculate velocity
            const velocity = data.velocity && data.velocity.length > 0
                ? (data.velocity.reduce((sum, v) => sum + v.resolved, 0) / data.velocity.length).toFixed(1)
                : '-';

            // Get critical bugs (>30 days)
            const criticalBugs = (window.bugAges || [])
                .filter(b => b.age > 30)
                .sort((a, b) => b.age - a.age)
                .slice(0, 5);

            // Get next milestone
            const nextMilestone = data.milestones?.find(m => m.status === 'in_progress');

            document.getElementById('summary-content').innerHTML = `
                <h1 style="color:#000;border-bottom:3px solid #1f6feb;padding-bottom:15px;margin-bottom:30px;">B4 Project Status Summary</h1>
                <p style="color:#666;margin-bottom:30px;">Generated: ${new Date().toLocaleDateString()} at ${new Date().toLocaleTimeString()}</p>

                <h2 style="color:#1f6feb;margin-bottom:15px;">Current Phase</h2>
                <p style="font-size:20px;font-weight:bold;margin-bottom:10px;">${data.project?.phase || 'N/A'}</p>
                <p style="margin-bottom:30px;">Next Milestone: <strong>${nextMilestone?.name || 'TBD'}</strong> (${nextMilestone?.date || 'TBD'})</p>

                <h2 style="color:#1f6feb;margin-bottom:15px;">Key Metrics</h2>
                <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:20px;margin-bottom:30px;">
                    <div style="background:#f0f0f0;padding:20px;border-radius:8px;text-align:center;">
                        <div style="font-size:32px;font-weight:bold;color:#1f6feb;">${bugs.length}</div>
                        <div style="color:#666;">Open Bugs</div>
                    </div>
                    <div style="background:#f0f0f0;padding:20px;border-radius:8px;text-align:center;">
                        <div style="font-size:32px;font-weight:bold;color:#1f6feb;">${tickets.length}</div>
                        <div style="color:#666;">Open Tickets</div>
                    </div>
                    <div style="background:#f0f0f0;padding:20px;border-radius:8px;text-align:center;">
                        <div style="font-size:32px;font-weight:bold;color:#1f6feb;">${velocity}/wk</div>
                        <div style="color:#666;">Avg SP/wk</div>
                    </div>
                    <div style="background:#f0f0f0;padding:20px;border-radius:8px;text-align:center;">
                        <div style="font-size:32px;font-weight:bold;color:#1f6feb;">${avgAge}d</div>
                        <div style="color:#666;">Avg Bug Age</div>
                    </div>
                </div>

                <h2 style="color:#1f6feb;margin-bottom:15px;">Top 5 Priorities</h2>
                <ol style="margin-bottom:30px;padding-left:20px;">
                    ${(data.priorities || []).map(p => `<li style="margin-bottom:8px;"><strong>[${p.ticket}]</strong> ${p.title}</li>`).join('')}
                </ol>

                ${criticalBugs.length > 0 ? `
                    <h2 style="color:#da3633;margin-bottom:15px;">Critical Bugs (&gt;30 days)</h2>
                    <ul style="margin-bottom:30px;padding-left:20px;">
                        ${criticalBugs.map(b => `<li style="margin-bottom:8px;"><strong>${b.key}</strong> (${b.age}d): ${b.summary}</li>`).join('')}
                    </ul>
                ` : ''}

                <div style="margin-top:40px;border-top:1px solid #ddd;padding-top:20px;">
                    <button onclick="window.print()" style="background:#1f6feb;color:#fff;border:none;padding:15px 30px;border-radius:8px;cursor:pointer;font-size:16px;margin-right:10px;">üñ®Ô∏è Print Report</button>
                    <button onclick="closeSummaryView()" style="background:#6e7681;color:#fff;border:none;padding:15px 30px;border-radius:8px;cursor:pointer;font-size:16px;">Close</button>
                </div>
            `;

            document.getElementById('summary-overlay').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function closeSummaryView() {
            document.getElementById('summary-overlay').style.display = 'none';
            document.body.style.overflow = '';
        }

        function showKeyboardHelp() {
            alert(`Keyboard Shortcuts:

Esc - Close overlays
R - Refresh data
S - Toggle sprint/8-week view
E - Export CSV
P - Print summary view
? - Show this help`);
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Don't trigger when typing in inputs (except for search-related keys)
            const isInput = document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA';

            // Always allow Escape
            if (e.key === 'Escape') {
                closeChartFullscreen();
                closeSummaryView();
                document.getElementById('search-results').style.display = 'none';
                document.getElementById('global-search').blur();
                return;
            }

            if (isInput) return;

            switch(e.key) {
                case 'r':
                    if (!e.ctrlKey && !e.metaKey) refreshData();
                    break;
                case 's':
                    if (!e.ctrlKey && !e.metaKey) toggleSprintView();
                    break;
                case 'e':
                    if (!e.ctrlKey && !e.metaKey) exportToCSV();
                    break;
                case 'p':
                    if (!e.ctrlKey && !e.metaKey) showSummaryView();
                    break;
                case '/':
                    e.preventDefault();
                    document.getElementById('global-search').focus();
                    break;
                case '?':
                    showKeyboardHelp();
                    break;
            }
        });

        // Shareable URLs
        function getUrlState() {
            const state = {};
            if (window.bugsFilter) {
                if (window.bugsFilter.custom) {
                    state.bf = window.bugsFilter.label;
                } else {
                    state.bf = `${window.bugsFilter.field}:${window.bugsFilter.value}`;
                }
            }
            if (window.ticketsFilter) {
                if (window.ticketsFilter.custom) {
                    state.tf = window.ticketsFilter.label;
                } else {
                    state.tf = `${window.ticketsFilter.field}:${window.ticketsFilter.value}`;
                }
            }
            if (window.sprintViewActive) state.sv = 1;
            if (!window.b4FilterActive) state.all = 1;
            return state;
        }

        function setUrlFromState() {
            const state = getUrlState();
            const hash = Object.keys(state).length > 0 ? '#' + new URLSearchParams(state).toString() : '';
            history.replaceState(null, '', window.location.pathname + hash);
        }

        function loadStateFromUrl() {
            if (!window.location.hash) return;
            try {
                const params = new URLSearchParams(window.location.hash.slice(1));

                if (params.get('bf')) {
                    const bf = params.get('bf');
                    if (bf.includes(':')) {
                        const [field, value] = bf.split(':');
                        window.bugsFilter = { field, value };
                    }
                }
                if (params.get('tf')) {
                    const tf = params.get('tf');
                    if (tf.includes(':')) {
                        const [field, value] = tf.split(':');
                        window.ticketsFilter = { field, value };
                    }
                }
                if (params.get('sv') === '1') {
                    window.sprintViewActive = true;
                }
                if (params.get('all') === '1') {
                    window.b4FilterActive = false;
                }
            } catch (e) {
                console.log('Failed to load state from URL:', e);
            }
        }

        function copyShareableLink() {
            setUrlFromState();
            const url = window.location.href;
            navigator.clipboard.writeText(url).then(() => {
                const btn = event.target;
                const original = btn.textContent;
                btn.textContent = '‚úì Copied!';
                btn.style.background = '#238636';
                setTimeout(() => {
                    btn.textContent = original;
                    btn.style.background = '#6e7681';
                }, 2000);
            }).catch(() => {
                prompt('Copy this URL:', url);
            });
        }

        // Global search functionality
        let searchTimeout;
        function globalSearch(query) {
            clearTimeout(searchTimeout);
            const dropdown = document.getElementById('search-results');

            if (!query || query.length < 2) {
                dropdown.style.display = 'none';
                return;
            }

            searchTimeout = setTimeout(() => {
                const q = query.toLowerCase();
                const bugs = window.bugsData || [];
                const tickets = window.ticketsData || [];
                const ftTickets = window.ftData || [];

                const matchingBugs = bugs.filter(b =>
                    b.key.toLowerCase().includes(q) ||
                    b.summary.toLowerCase().includes(q) ||
                    b.assignee.toLowerCase().includes(q)
                ).slice(0, 5);

                const matchingTickets = tickets.filter(t =>
                    t.key.toLowerCase().includes(q) ||
                    t.summary.toLowerCase().includes(q) ||
                    t.assignee.toLowerCase().includes(q)
                ).slice(0, 5);

                const matchingFt = ftTickets.filter(t =>
                    t.key.toLowerCase().includes(q) ||
                    t.summary.toLowerCase().includes(q) ||
                    t.assignee.toLowerCase().includes(q)
                ).slice(0, 5);

                if (matchingBugs.length === 0 && matchingTickets.length === 0 && matchingFt.length === 0) {
                    dropdown.innerHTML = '<div style="padding:12px;color:#8b949e;">No results found</div>';
                } else {
                    dropdown.innerHTML = `
                        ${matchingBugs.length ? '<div style="padding:8px 12px;color:#8b949e;font-size:11px;text-transform:uppercase;border-bottom:1px solid #30363d;">Bugs</div>' : ''}
                        ${matchingBugs.map(b => `
                            <div onclick="window.open('${b.url}', '_blank')" style="padding:10px 12px;cursor:pointer;border-bottom:1px solid #21262d;display:flex;justify-content:space-between;" onmouseover="this.style.background='#21262d'" onmouseout="this.style.background='transparent'">
                                <span><strong style="color:#58a6ff;">${b.key}</strong> <span style="color:#8b949e;">- ${b.summary.substring(0, 40)}...</span></span>
                                <span style="color:#8b949e;font-size:12px;">${b.status}</span>
                            </div>
                        `).join('')}
                        ${matchingTickets.length ? '<div style="padding:8px 12px;color:#8b949e;font-size:11px;text-transform:uppercase;border-bottom:1px solid #30363d;">Tickets</div>' : ''}
                        ${matchingTickets.map(t => `
                            <div onclick="window.open('${t.url}', '_blank')" style="padding:10px 12px;cursor:pointer;border-bottom:1px solid #21262d;display:flex;justify-content:space-between;" onmouseover="this.style.background='#21262d'" onmouseout="this.style.background='transparent'">
                                <span><strong style="color:#58a6ff;">${t.key}</strong> <span style="color:#8b949e;">- ${t.summary.substring(0, 40)}...</span></span>
                                <span style="color:#8b949e;font-size:12px;">${t.status}</span>
                            </div>
                        `).join('')}
                        ${matchingFt.length ? '<div style="padding:8px 12px;color:#8b949e;font-size:11px;text-transform:uppercase;border-bottom:1px solid #30363d;">Field Test</div>' : ''}
                        ${matchingFt.map(t => `
                            <div onclick="window.open('${t.url}', '_blank')" style="padding:10px 12px;cursor:pointer;border-bottom:1px solid #21262d;display:flex;justify-content:space-between;" onmouseover="this.style.background='#21262d'" onmouseout="this.style.background='transparent'">
                                <span><strong style="color:#58a6ff;">${t.key}</strong> <span style="color:#8b949e;">- ${t.summary.substring(0, 40)}...</span></span>
                                <span style="color:#8b949e;font-size:12px;">${t.status}</span>
                            </div>
                        `).join('')}
                    `;
                }
                dropdown.style.display = 'block';
            }, 200);
        }

        function handleSearchKey(e) {
            if (e.key === 'Escape') {
                document.getElementById('search-results').style.display = 'none';
                e.target.blur();
            }
        }

        // Close search dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('#global-search') && !e.target.closest('#search-results')) {
                document.getElementById('search-results').style.display = 'none';
            }
        });

        function filterBugsByAge(bucket) {
            const ranges = {
                '<7d': [0, 7],
                '7-14d': [7, 14],
                '14-30d': [14, 30],
                '>30d': [30, Infinity]
            };
            const [min, max] = ranges[bucket];

            // Filter bugs by age range
            window.bugsAgeFilter = { min, max };
            window.bugsPage = 1;

            // Custom filter for age-based filtering
            const filteredBugs = window.bugsData.filter(b => {
                const age = calculateBugAge(b.created);
                return age >= min && age < max;
            });

            // Show filter bar
            document.getElementById('bugs-filter').style.display = 'flex';
            document.getElementById('bugs-filter').innerHTML = `<span>Filtered by:</span> <span class="filter-value">age = "${bucket}"</span> <button onclick="clearBugsFilter()">‚úï Clear</button>`;

            // Render filtered data
            const start = 0;
            const end = window.bugsPerPage;
            const pageData = filteredBugs.slice(start, end);
            const totalPages = Math.ceil(filteredBugs.length / window.bugsPerPage) || 1;

            const html = pageData.map(bug => {
                const age = calculateBugAge(bug.created);
                const ageStyle = getAgeStyle(age);
                return `
                <tr>
                    <td><a class="ticket-link" href="${bug.url}" target="_blank">${bug.key}</a></td>
                    <td class="truncate" title="${bug.summary}">${bug.summary}</td>
                    <td><span class="status-badge status-${bug.status.toLowerCase().replace(' ', '-')}">${bug.status}</span></td>
                    <td>${bug.assignee}</td>
                    <td>${bug.priority || '-'}</td>
                    <td>${bug.version || '-'}</td>
                    <td style="${ageStyle}">${age}d</td>
                </tr>`;
            }).join('');
            document.getElementById('bugs-body').innerHTML = html || '<tr><td colspan="7">No bugs</td></tr>';

            // Update pagination
            let paginationHtml = `<span class="page-info">1 / ${totalPages} (${filteredBugs.length})</span>`;
            document.getElementById('bugs-pagination').innerHTML = paginationHtml;
        }

        function renderDashboard(data) {
            // Project phase
            document.getElementById('project-phase').textContent =
                `${data.project.name} ‚Ä¢ ${data.project.phase}`;

            // Sprint button - link to active sprint on board
            if (data.links.active_sprint) {
                document.getElementById('sprint-btn').href = data.links.active_sprint;
                document.getElementById('sprint-btn').textContent = `üéØ ${data.links.active_sprint_name || 'Active Sprint'}`;
            } else {
                document.getElementById('sprint-btn').style.display = 'none';
            }

            // Milestones (table)
            const milestonesHtml = data.milestones.map(m => {
                if (m.status === 'empty') {
                    return '<tr style="height:28px;"><td></td><td></td><td></td></tr>';
                }
                const statusText = m.status === 'done' ? '‚úì Done' : m.status === 'in_progress' ? '‚óè Active' : m.status === 'blocked' ? '‚äò Blocked' : '‚óã Backlog';
                return `<tr>
                    <td>${m.name}</td>
                    <td><span class="status-badge status-${m.status}">${statusText}</span></td>
                    <td>${m.date || '-'}</td>
                </tr>`;
            }).join('');
            document.getElementById('milestones').innerHTML = milestonesHtml;

            // Metrics
            const metricsHtml = `
                <div class="metric-box">
                    <div class="metric-value">${data.metrics.total_bugs}</div>
                    <div class="metric-label">Open Bugs</div>
                </div>
                <div class="metric-box">
                    <div class="metric-value">${data.metrics.total_tickets}</div>
                    <div class="metric-label">FS Tickets</div>
                </div>
                <div class="metric-box">
                    <div class="metric-value">${data.metrics.bug_status['In Progress'] || 0}</div>
                    <div class="metric-label">Bugs In Progress</div>
                </div>
                <div class="metric-box">
                    <div class="metric-value">${data.metrics.ticket_status['In Progress'] || 0}</div>
                    <div class="metric-label">Tickets In Progress</div>
                </div>
            `;
            document.getElementById('metrics').innerHTML = metricsHtml;

            // FW Releases
            const fwReleasesHtml = (data.fw_releases || []).map(r => {
                if (!r.name) return '';
                return `<tr>
                    <td><a class="ticket-link" href="${r.url}" target="_blank">${r.name.replace('fw2-b4-', '')}</a></td>
                    <td><span class="status-badge ${r.released ? 'status-done' : 'status-in_progress'}">${r.released ? '‚úì' : '‚óã'}</span></td>
                    <td>${r.releaseDate || '-'}</td>
                </tr>`;
            }).join('');
            document.getElementById('fw-releases-body').innerHTML = fwReleasesHtml || '<tr><td colspan="3">No releases</td></tr>';

            // MCU Releases
            const mcuReleasesHtml = (data.mcu_releases || []).map(r => {
                if (!r.name) return '';
                return `<tr>
                    <td><a class="ticket-link" href="${r.url}" target="_blank">${r.name.replace('mcu-b4-', '')}</a></td>
                    <td><span class="status-badge ${r.released ? 'status-done' : 'status-in_progress'}">${r.released ? '‚úì' : '‚óã'}</span></td>
                    <td>${r.releaseDate || '-'}</td>
                </tr>`;
            }).join('');
            document.getElementById('mcu-releases-body').innerHTML = mcuReleasesHtml || '<tr><td colspan="3">No MCU releases</td></tr>';

            // Priorities
            const prioritiesHtml = data.priorities.map((p, i) => `
                <li class="priority-item">
                    <span><span class="priority-num">${i + 1}</span>${p.title}</span>
                    <a class="priority-ticket" href="${p.url || 'https://getnexar.atlassian.net/browse/' + p.ticket}" target="_blank">${p.ticket}</a>
                </li>
            `).join('');
            document.getElementById('priorities').innerHTML = prioritiesHtml || '<li>No priorities in active sprint</li>';

            // Links
            const linksHtml = `
                <a href="${data.links.timeline}" target="_blank" style="background:#238636;color:#fff;padding:8px 12px;border-radius:6px;font-weight:500;">üìÖ Project Timeline</a>
                <a href="${data.links.release_plan}" target="_blank">üìÑ Release Plan (Confluence)</a>
                <a href="${data.links.release_confluence}" target="_blank">üì¶ FW Releases (Confluence)</a>
                <div class="dropdown">
                    <a href="#" class="dropdown-toggle" onclick="event.preventDefault(); this.parentElement.classList.toggle('open')">üìã JIRA Internal ‚ñæ</a>
                    <div class="dropdown-menu">
                        <a href="${data.links.jira_board}" target="_blank">FS Board (Backlog)</a>
                        <a href="${data.links.br_bugs}" target="_blank">BR Bugs (Beam4)</a>
                        <a href="${data.links.ft_tickets}" target="_blank">FT Tickets (Beam4k)</a>
                    </div>
                </div>
                <div class="dropdown">
                    <a href="#" class="dropdown-toggle" onclick="event.preventDefault(); this.parentElement.classList.toggle('open')">üè≠ JIRA External ‚ñæ</a>
                    <div class="dropdown-menu">
                        <a href="${data.links.chicony_jira}" target="_blank">B4 (Chicony)</a>
                        <a href="${data.links.dastic_jira}" target="_blank">DAS (Dastic)</a>
                        <a href="https://getnexar-acko.atlassian.net/jira/software/projects/KAN/boards/1" target="_blank">PICO (Acko)</a>
                    </div>
                </div>
                <a href="${data.links.sprint_planning}" target="_blank">üóìÔ∏è ${data.links.sprint_title || 'Sprint Planning'}</a>
                <a href="${data.links.serial_numbers}" target="_blank">üìä Serial Numbers (FT Tracking)</a>
                <a href="${data.links.odm_export}" target="_blank">üìÅ ODM Export (Google Drive)</a>
                <div class="dropdown">
                    <a href="#" class="dropdown-toggle" onclick="event.preventDefault(); this.parentElement.classList.toggle('open')">üí¨ Slack Internal ‚ñæ</a>
                    <div class="dropdown-menu">
                        <a href="${data.links.slack_eng}" target="_blank">#eng-beam4k</a>
                        <a href="${data.links.slack_general}" target="_blank">#general-beam4k</a>
                    </div>
                </div>
                <div class="dropdown">
                    <a href="#" class="dropdown-toggle" onclick="event.preventDefault(); this.parentElement.classList.toggle('open')">üí¨ Slack External ‚ñæ</a>
                    <div class="dropdown-menu">
                        <a href="https://app.slack.com/client/T08V7G1079N/C090K46SA7P" target="_blank">AONI</a>
                        <a href="https://app.slack.com/client/T0780SDQR5W/C077HGQ1ASF" target="_blank">Chicony</a>
                    </div>
                </div>
                <a href="${data.links.jenkins}" target="_blank">üîß Jenkins (B4 Builds)</a>
                <div class="dropdown">
                    <a href="#" class="dropdown-toggle" onclick="event.preventDefault(); this.parentElement.classList.toggle('open')">üêô GitHub ‚ñæ</a>
                    <div class="dropdown-menu">
                        <a href="${data.links.gh_chicony}" target="_blank">nexar-chicony</a>
                        <a href="${data.links.gh_sdk}" target="_blank">nexar-client-sdk</a>
                        <a href="${data.links.gh_hub}" target="_blank">b4-project-hub</a>
                        <a href="${data.links.gh_my_prs}" target="_blank">üì§ My PRs</a>
                        <a href="${data.links.gh_review_prs}" target="_blank">üëÄ Review Requests</a>
                    </div>
                </div>
            `;
            document.getElementById('links').innerHTML = linksHtml;

            // Bugs table with pagination
            window.bugsData = data.bugs;
            window.bugsPage = 1;
            window.bugsPerPage = 10;
            document.getElementById('bugs-count').textContent = data.bugs.length;
            document.getElementById('bugs-link').href = data.links.br_bugs;
            renderBugsPage();

            // Bug Aging Analysis chart
            renderBugAgingChart(data.bugs, data.velocity);

            // Team Metrics charts
            renderTeamVelocityChart(data.team_velocity);
            renderWorkloadChart(data.workload);

            // Tickets table with pagination
            window.ticketsData = data.tickets;
            window.ticketsPage = 1;
            window.ticketsPerPage = 10;
            document.getElementById('tickets-count').textContent = data.tickets.length;
            document.getElementById('tickets-link').href = data.links.jira_board;
            renderTicketsPage();

            // FT tickets table with pagination
            window.ftData = data.ft_tickets || [];
            window.ftPage = 1;
            window.ftPerPage = 10;
            document.getElementById('ft-count').textContent = window.ftData.length;
            document.getElementById('ft-link').href = data.links.ft_tickets || '#';
            renderFtPage();

            // Velocity Chart - Cumulative
            if (data.velocity && data.velocity.length > 0) {
                // Store data for fullscreen chart
                window.lastVelocityData = data;

                const ctx = document.getElementById('velocity-chart').getContext('2d');
                // Destroy existing chart if any
                if (window.velocityChart) window.velocityChart.destroy();

                // Calculate cumulative values
                let cumResolved = 0, cumCreated = 0;
                const initialOpen = data.initial_open || 0;
                const cumulativeResolved = data.velocity.map(v => { cumResolved += v.resolved; return cumResolved; });
                cumCreated = 0;
                const cumulativeCreated = data.velocity.map(v => { cumCreated += v.created; return initialOpen + cumCreated; });

                // Open bugs at each week (starting from initial_bugs)
                let openBugs = data.initial_bugs || 0;
                const openBugsLine = data.velocity.map(v => {
                    openBugs += (v.bugs_created || 0) - (v.bugs_resolved || 0);
                    return openBugs;
                });

                // Velocity trend line (positive slope showing cumulative at avg rate)
                const totalResolved = data.velocity.reduce((sum, v) => sum + v.resolved, 0);
                const avgVelocity = totalResolved / data.velocity.length;
                const velocityTrendLine = data.velocity.map((v, i) => avgVelocity * (i + 1));

                window.velocityChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.velocity.map(v => v.week),
                        datasets: [
                            {
                                label: 'Open Bugs',
                                data: openBugsLine,
                                borderColor: '#da3633',
                                backgroundColor: 'rgba(218, 54, 51, 0.1)',
                                fill: true,
                                tension: 0.3,
                                borderWidth: 2
                            },
                            {
                                label: `Velocity Trend (${avgVelocity.toFixed(1)} SP/wk)`,
                                data: velocityTrendLine,
                                borderColor: 'rgba(255, 255, 255, 0.4)',
                                borderDash: [5, 5],
                                backgroundColor: 'transparent',
                                fill: false,
                                tension: 0,
                                borderWidth: 2,
                                pointRadius: 0,
                                datalabels: { display: false }
                            },
                            {
                                label: 'SP Resolved (cumulative)',
                                data: cumulativeResolved,
                                borderColor: '#238636',
                                backgroundColor: 'rgba(35, 134, 54, 0.1)',
                                fill: true,
                                tension: 0.3
                            },
                            {
                                label: 'SP Created (cumulative)',
                                data: cumulativeCreated,
                                borderColor: '#1f6feb',
                                backgroundColor: 'rgba(31, 111, 235, 0.1)',
                                fill: true,
                                tension: 0.3
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { reverse: true, labels: { color: '#8b949e' } },
                            datalabels: {
                                display: (ctx) => ctx.dataIndex % 2 === 1,
                                color: '#c9d1d9',
                                font: { size: 10 },
                                anchor: 'end',
                                align: 'top'
                            }
                        },
                        scales: {
                            x: { ticks: { color: '#8b949e' }, grid: { color: '#21262d' } },
                            y: { ticks: { color: '#8b949e' }, grid: { color: '#21262d' }, beginAtZero: true }
                        }
                    },
                    plugins: [ChartDataLabels]
                });
            }

            // Updated timestamp
            const updated = new Date(data.updated);
            document.getElementById('updated').textContent = `Last updated: ${updated.toLocaleString()}`;

            // Re-render current view (sprint or 8-week) after data refresh
            if (window.sprintViewActive) {
                renderSprintChart();
                renderSprintIssues();
            }
        }

        async function refreshData() {
            const btn = document.getElementById('refresh-btn');
            btn.disabled = true;
            btn.classList.add('loading');
            btn.textContent = '‚è≥ Fetching from JIRA...';

            try {
                // Call the API to fetch fresh data from JIRA
                const response = await fetch('/api/refresh');
                const result = await response.json();

                if (result.success) {
                    // Reload the dashboard with new data (skip JIRA - already fetched above)
                    await loadDashboard(true);
                    btn.textContent = '‚úÖ Updated!';
                } else {
                    btn.textContent = '‚ùå ' + (result.message || 'Failed');
                }

                setTimeout(() => {
                    btn.textContent = 'üîÑ Refresh Data';
                    btn.disabled = false;
                    btn.classList.remove('loading');
                }, 2000);
            } catch (e) {
                btn.textContent = '‚ùå Error';
                setTimeout(() => {
                    btn.textContent = 'üîÑ Refresh Data';
                    btn.disabled = false;
                    btn.classList.remove('loading');
                }, 2000);
            }
        }

        function renderBugsPage() {
            // Apply filter if set
            let filteredData = window.bugsData;
            if (window.bugsFilter) {
                if (window.bugsFilter.custom && window.bugsFilter.fn) {
                    filteredData = window.bugsData.filter(window.bugsFilter.fn);
                    document.getElementById('bugs-filter').style.display = 'flex';
                    document.getElementById('bugs-filter').innerHTML = `<span>Filtered by:</span> <span class="filter-value">${window.bugsFilter.label}</span> <button onclick="clearBugsFilter()">‚úï Clear</button>`;
                } else {
                    filteredData = window.bugsData.filter(b => b[window.bugsFilter.field] === window.bugsFilter.value);
                    document.getElementById('bugs-filter').style.display = 'flex';
                    document.getElementById('bugs-filter').innerHTML = `<span>Filtered by:</span> <span class="filter-value">${window.bugsFilter.field} = "${window.bugsFilter.value}"</span> <button onclick="clearBugsFilter()">‚úï Clear</button>`;
                }
            } else {
                document.getElementById('bugs-filter').style.display = 'none';
            }

            const start = (window.bugsPage - 1) * window.bugsPerPage;
            const end = start + window.bugsPerPage;
            const pageData = filteredData.slice(start, end);
            const totalPages = Math.ceil(filteredData.length / window.bugsPerPage) || 1;

            const html = pageData.map(bug => {
                const age = calculateBugAge(bug.created);
                const ageStyle = getAgeStyle(age);
                return `
                <tr>
                    <td><a class="ticket-link" href="${bug.url}" target="_blank">${bug.key}</a></td>
                    <td class="truncate" title="${bug.summary}">${bug.summary}</td>
                    <td><span class="status-badge status-${bug.status.toLowerCase().replace(' ', '-')} clickable" onclick="filterBugs('status','${bug.status}')">${bug.status}</span></td>
                    <td class="clickable" onclick="filterBugs('assignee','${bug.assignee}')">${bug.assignee}</td>
                    <td class="clickable" onclick="filterBugs('priority','${bug.priority || '-'}')">${bug.priority || '-'}</td>
                    <td class="clickable" onclick="filterBugs('version','${bug.version || '-'}')">${bug.version || '-'}</td>
                    <td style="text-align:center;">${bug.story_points || 2}</td>
                    <td style="${ageStyle}">${age}d</td>
                </tr>`;
            }).join('');
            document.getElementById('bugs-body').innerHTML = html || '<tr><td colspan="8">No bugs</td></tr>';

            let paginationHtml = `<button onclick="window.bugsPage=1; renderBugsPage()" ${window.bugsPage === 1 ? 'disabled' : ''}>&laquo;</button>`;
            paginationHtml += `<button onclick="window.bugsPage--; renderBugsPage()" ${window.bugsPage === 1 ? 'disabled' : ''}>&lsaquo; Prev</button>`;
            paginationHtml += `<span class="page-info">${window.bugsPage} / ${totalPages} (${filteredData.length})</span>`;
            paginationHtml += `<button onclick="window.bugsPage++; renderBugsPage()" ${window.bugsPage >= totalPages ? 'disabled' : ''}>Next &rsaquo;</button>`;
            paginationHtml += `<button onclick="window.bugsPage=${totalPages}; renderBugsPage()" ${window.bugsPage >= totalPages ? 'disabled' : ''}>&raquo;</button>`;
            document.getElementById('bugs-pagination').innerHTML = paginationHtml;
        }

        function filterBugs(field, value) {
            window.bugsFilter = { field, value };
            window.bugsPage = 1;
            renderBugsPage();
        }

        function clearBugsFilter() {
            window.bugsFilter = null;
            window.bugsPage = 1;
            updatePresetButtons('bugs', null);
            renderBugsPage();
        }

        function applyBugsPreset(preset) {
            const bugs = window.bugsData || [];
            let filterFn, filterLabel;

            switch (preset) {
                case 'critical':
                    filterFn = b => calculateBugAge(b.created) > 30;
                    filterLabel = 'age > 30 days';
                    break;
                case 'unassigned':
                    filterFn = b => b.assignee === 'Unassigned';
                    filterLabel = 'assignee = Unassigned';
                    break;
                case 'in_progress':
                    filterFn = b => b.status === 'In Progress';
                    filterLabel = 'status = In Progress';
                    break;
                case 'high_priority':
                    filterFn = b => b.priority && (b.priority.includes('High') || b.priority.includes('P1'));
                    filterLabel = 'priority = High';
                    break;
                default:
                    clearBugsFilter();
                    return;
            }

            window.bugsFilter = { custom: true, fn: filterFn, label: filterLabel };
            window.bugsPage = 1;
            updatePresetButtons('bugs', preset);
            renderBugsPage();
        }

        function applyTicketsPreset(preset) {
            const tickets = window.ticketsData || [];
            let filterFn, filterLabel;

            switch (preset) {
                case 'unassigned':
                    filterFn = t => t.assignee === 'Unassigned';
                    filterLabel = 'assignee = Unassigned';
                    break;
                case 'in_progress':
                    filterFn = t => t.status === 'In Progress';
                    filterLabel = 'status = In Progress';
                    break;
                case 'high_priority':
                    filterFn = t => t.priority && (t.priority.includes('High') || t.priority.includes('P1'));
                    filterLabel = 'priority = High';
                    break;
                case 'todo':
                    filterFn = t => t.status === 'To Do' || t.status === 'Selected for Execution';
                    filterLabel = 'status = To Do';
                    break;
                default:
                    clearTicketsFilter();
                    return;
            }

            window.ticketsFilter = { custom: true, fn: filterFn, label: filterLabel };
            window.ticketsPage = 1;
            updatePresetButtons('tickets', preset);
            renderTicketsPage();
        }

        function updatePresetButtons(type, activePreset) {
            const container = document.querySelector(`#${type === 'bugs' ? 'bugs-body' : 'tickets-body'}`)?.closest('.card')?.querySelector('.filter-presets');
            if (!container) return;
            container.querySelectorAll('.preset-btn').forEach(btn => {
                btn.classList.remove('active');
                if (activePreset && btn.textContent.toLowerCase().includes(activePreset.replace('_', ' ').slice(0, 4))) {
                    btn.classList.add('active');
                }
            });
        }

        function sortBugs(field) {
            // Toggle sort direction
            if (window.bugsSortField === field) {
                window.bugsSortDir = window.bugsSortDir === 'asc' ? 'desc' : 'asc';
            } else {
                window.bugsSortField = field;
                window.bugsSortDir = 'asc';
            }

            // Sort data
            window.bugsData.sort((a, b) => {
                // Special handling for age (numeric sort based on created date)
                if (field === 'age') {
                    const ageA = calculateBugAge(a.created);
                    const ageB = calculateBugAge(b.created);
                    return window.bugsSortDir === 'asc' ? ageA - ageB : ageB - ageA;
                }
                // String sort for other fields
                let valA = (a[field] || '').toString().toLowerCase();
                let valB = (b[field] || '').toString().toLowerCase();
                if (valA < valB) return window.bugsSortDir === 'asc' ? -1 : 1;
                if (valA > valB) return window.bugsSortDir === 'asc' ? 1 : -1;
                return 0;
            });

            // Update sort indicators
            ['key','summary','status','assignee','priority','version','age'].forEach(f => {
                document.getElementById('bugs-sort-' + f).textContent = '';
            });
            document.getElementById('bugs-sort-' + field).textContent = window.bugsSortDir === 'asc' ? '‚ñ≤' : '‚ñº';

            window.bugsPage = 1;
            renderBugsPage();
        }

        function renderTicketsPage() {
            // Apply filter if set
            let filteredData = window.ticketsData;
            if (window.ticketsFilter) {
                if (window.ticketsFilter.custom && window.ticketsFilter.fn) {
                    filteredData = window.ticketsData.filter(window.ticketsFilter.fn);
                    document.getElementById('tickets-filter').style.display = 'flex';
                    document.getElementById('tickets-filter').innerHTML = `<span>Filtered by:</span> <span class="filter-value">${window.ticketsFilter.label}</span> <button onclick="clearTicketsFilter()">‚úï Clear</button>`;
                } else {
                    filteredData = window.ticketsData.filter(t => t[window.ticketsFilter.field] === window.ticketsFilter.value);
                    document.getElementById('tickets-filter').style.display = 'flex';
                    document.getElementById('tickets-filter').innerHTML = `<span>Filtered by:</span> <span class="filter-value">${window.ticketsFilter.field} = "${window.ticketsFilter.value}"</span> <button onclick="clearTicketsFilter()">‚úï Clear</button>`;
                }
            } else {
                document.getElementById('tickets-filter').style.display = 'none';
            }

            const start = (window.ticketsPage - 1) * window.ticketsPerPage;
            const end = start + window.ticketsPerPage;
            const pageData = filteredData.slice(start, end);
            const totalPages = Math.ceil(filteredData.length / window.ticketsPerPage) || 1;

            const html = pageData.map(t => `
                <tr>
                    <td><a class="ticket-link" href="${t.url}" target="_blank">${t.key}</a></td>
                    <td class="truncate" title="${t.summary}">${t.summary}</td>
                    <td><span class="status-badge status-${t.status.toLowerCase().replace(' ', '-')} clickable" onclick="filterTickets('status','${t.status}')">${t.status}</span></td>
                    <td class="clickable" onclick="filterTickets('assignee','${t.assignee}')">${t.assignee}</td>
                    <td class="clickable" onclick="filterTickets('priority','${t.priority || '-'}')">${t.priority || '-'}</td>
                    <td class="clickable" onclick="filterTickets('version','${t.version || '-'}')">${t.version || '-'}</td>
                    <td style="text-align:center;">${t.story_points || 2}</td>
                </tr>
            `).join('');
            document.getElementById('tickets-body').innerHTML = html || '<tr><td colspan="7">No tickets</td></tr>';

            // Pagination controls
            let paginationHtml = `<button onclick="window.ticketsPage=1; renderTicketsPage()" ${window.ticketsPage === 1 ? 'disabled' : ''}>&laquo;</button>`;
            paginationHtml += `<button onclick="window.ticketsPage--; renderTicketsPage()" ${window.ticketsPage === 1 ? 'disabled' : ''}>&lsaquo; Prev</button>`;
            paginationHtml += `<span class="page-info">${window.ticketsPage} / ${totalPages} (${filteredData.length})</span>`;
            paginationHtml += `<button onclick="window.ticketsPage++; renderTicketsPage()" ${window.ticketsPage >= totalPages ? 'disabled' : ''}>Next &rsaquo;</button>`;
            paginationHtml += `<button onclick="window.ticketsPage=${totalPages}; renderTicketsPage()" ${window.ticketsPage >= totalPages ? 'disabled' : ''}>&raquo;</button>`;
            document.getElementById('tickets-pagination').innerHTML = paginationHtml;
        }

        function filterTickets(field, value) {
            window.ticketsFilter = { field, value };
            window.ticketsPage = 1;
            renderTicketsPage();
        }

        function clearTicketsFilter() {
            window.ticketsFilter = null;
            window.ticketsPage = 1;
            updatePresetButtons('tickets', null);
            renderTicketsPage();
        }

        // FT Field Test table functions
        function renderFtPage() {
            // Apply filter if set
            let filteredData = window.ftData || [];
            if (window.ftFilter) {
                if (window.ftFilter.custom && window.ftFilter.fn) {
                    filteredData = filteredData.filter(window.ftFilter.fn);
                    document.getElementById('ft-filter').style.display = 'flex';
                    document.getElementById('ft-filter').innerHTML = `<span>Filtered by:</span> <span class="filter-value">${window.ftFilter.label}</span> <button onclick="clearFtFilter()">‚úï Clear</button>`;
                } else {
                    filteredData = filteredData.filter(t => t[window.ftFilter.field] === window.ftFilter.value);
                    document.getElementById('ft-filter').style.display = 'flex';
                    document.getElementById('ft-filter').innerHTML = `<span>Filtered by:</span> <span class="filter-value">${window.ftFilter.field} = "${window.ftFilter.value}"</span> <button onclick="clearFtFilter()">‚úï Clear</button>`;
                }
            } else {
                document.getElementById('ft-filter').style.display = 'none';
            }

            const start = (window.ftPage - 1) * window.ftPerPage;
            const end = start + window.ftPerPage;
            const pageData = filteredData.slice(start, end);
            const totalPages = Math.ceil(filteredData.length / window.ftPerPage) || 1;

            const html = pageData.map(t => {
                const age = calculateBugAge(t.created);
                const ageStyle = getAgeStyle(age);
                return `
                <tr>
                    <td><a class="ticket-link" href="${t.url}" target="_blank">${t.key}</a></td>
                    <td class="truncate" title="${t.summary}">${t.summary}</td>
                    <td><span class="status-badge status-${t.status.toLowerCase().replace(' ', '-')} clickable" onclick="filterFt('status','${t.status}')">${t.status}</span></td>
                    <td class="clickable" onclick="filterFt('assignee','${t.assignee}')">${t.assignee}</td>
                    <td class="clickable" onclick="filterFt('priority','${t.priority || '-'}')">${t.priority || '-'}</td>
                    <td style="text-align:center;">${t.story_points || 2}</td>
                    <td style="${ageStyle}">${age}d</td>
                </tr>`;
            }).join('');
            document.getElementById('ft-body').innerHTML = html || '<tr><td colspan="7">No FT tickets with Beam4k label</td></tr>';

            // Pagination controls
            let paginationHtml = `<button onclick="window.ftPage=1; renderFtPage()" ${window.ftPage === 1 ? 'disabled' : ''}>&laquo;</button>`;
            paginationHtml += `<button onclick="window.ftPage--; renderFtPage()" ${window.ftPage === 1 ? 'disabled' : ''}>&lsaquo; Prev</button>`;
            paginationHtml += `<span class="page-info">${window.ftPage} / ${totalPages} (${filteredData.length})</span>`;
            paginationHtml += `<button onclick="window.ftPage++; renderFtPage()" ${window.ftPage >= totalPages ? 'disabled' : ''}>Next &rsaquo;</button>`;
            paginationHtml += `<button onclick="window.ftPage=${totalPages}; renderFtPage()" ${window.ftPage >= totalPages ? 'disabled' : ''}>&raquo;</button>`;
            document.getElementById('ft-pagination').innerHTML = paginationHtml;
        }

        function filterFt(field, value) {
            window.ftFilter = { field, value };
            window.ftPage = 1;
            renderFtPage();
        }

        function clearFtFilter() {
            window.ftFilter = null;
            window.ftPage = 1;
            updatePresetButtons('ft', null);
            renderFtPage();
        }

        function applyFtPreset(preset) {
            let filterFn, filterLabel;

            switch (preset) {
                case 'unassigned':
                    filterFn = t => t.assignee === 'Unassigned';
                    filterLabel = 'assignee = Unassigned';
                    break;
                case 'in_progress':
                    filterFn = t => t.status === 'In Progress' || t.status === 'On L2 Support';
                    filterLabel = 'status = In Progress';
                    break;
                case 'high_priority':
                    filterFn = t => t.priority && (t.priority.includes('High') || t.priority.includes('P1'));
                    filterLabel = 'priority = High';
                    break;
                default:
                    clearFtFilter();
                    return;
            }

            window.ftFilter = { custom: true, fn: filterFn, label: filterLabel };
            window.ftPage = 1;
            updatePresetButtons('ft', preset);
            renderFtPage();
        }

        function sortFt(field) {
            // Toggle sort direction
            if (window.ftSortField === field) {
                window.ftSortDir = window.ftSortDir === 'asc' ? 'desc' : 'asc';
            } else {
                window.ftSortField = field;
                window.ftSortDir = 'asc';
            }

            // Sort data
            window.ftData.sort((a, b) => {
                // Special handling for age (numeric sort based on created date)
                if (field === 'age') {
                    const ageA = calculateBugAge(a.created);
                    const ageB = calculateBugAge(b.created);
                    return window.ftSortDir === 'asc' ? ageA - ageB : ageB - ageA;
                }
                // Numeric sort for story_points
                if (field === 'story_points') {
                    const valA = a[field] || 2;
                    const valB = b[field] || 2;
                    return window.ftSortDir === 'asc' ? valA - valB : valB - valA;
                }
                // String sort for other fields
                let valA = (a[field] || '').toString().toLowerCase();
                let valB = (b[field] || '').toString().toLowerCase();
                if (valA < valB) return window.ftSortDir === 'asc' ? -1 : 1;
                if (valA > valB) return window.ftSortDir === 'asc' ? 1 : -1;
                return 0;
            });

            // Update sort indicators
            ['key','summary','status','assignee','priority','story_points','age'].forEach(f => {
                const el = document.getElementById('ft-sort-' + f);
                if (el) el.textContent = '';
            });
            const sortEl = document.getElementById('ft-sort-' + field);
            if (sortEl) sortEl.textContent = window.ftSortDir === 'asc' ? '‚ñ≤' : '‚ñº';

            window.ftPage = 1;
            renderFtPage();
        }

        // Sprint view toggle
        window.sprintViewActive = false;
        window.b4FilterActive = true; // Default: show B4 only

        function toggleSprintView() {
            window.sprintViewActive = !window.sprintViewActive;
            const btn = document.getElementById('sprint-velocity-btn');
            const b4Btn = document.getElementById('b4-filter-btn');
            const title = document.getElementById('velocity-title');
            const issuesContainer = document.getElementById('sprint-issues-container');

            if (window.sprintViewActive) {
                btn.textContent = 'üìä 8 Week View';
                btn.style.background = '#238636';
                const sprintData = window.lastVelocityData?.sprint_data;
                title.innerHTML = `(${sprintData?.name || 'Current Sprint'})${getSprintPredictionBadge()}`;
                issuesContainer.style.display = 'block';
                renderSprintChart();
                renderSprintIssues();
            } else {
                btn.textContent = 'üìÖ Sprint View';
                btn.style.background = '#1f6feb';
                title.innerHTML = '(Last 8 Weeks)';
                issuesContainer.style.display = 'none';
                render8WeekChart();
            }
        }

        function toggleB4Filter() {
            window.b4FilterActive = !window.b4FilterActive;
            const btn = document.getElementById('b4-filter-btn');
            const title = document.getElementById('velocity-title');

            if (window.b4FilterActive) {
                btn.textContent = 'üè∑Ô∏è B4 Only';
                btn.style.background = '#238636';
            } else {
                btn.textContent = 'üìã All Issues';
                btn.style.background = '#6e7681';
            }

            if (window.sprintViewActive) {
                const sprintData = window.lastVelocityData?.sprint_data;
                title.innerHTML = `(${sprintData?.name || 'Current Sprint'})${getSprintPredictionBadge()}`;
                renderSprintChart();
                renderSprintIssues();
            } else {
                render8WeekChart();
            }
        }

        function getFilteredSprintIssues() {
            const data = window.lastVelocityData;
            if (!data || !data.sprint_data) return [];

            const issues = data.sprint_data.issues || [];
            if (window.b4FilterActive) {
                // Filter to B4 issues only (has Beam4k label)
                return issues.filter(i => i.is_b4 === true);
            }
            return issues;
        }

        function predictSprintCompletion() {
            const data = window.lastVelocityData;
            if (!data || !data.sprint_data) return null;

            const issues = getFilteredSprintIssues();
            const total = issues.length;
            if (total === 0) return null;

            const done = issues.filter(i => ['Done', 'Closed'].includes(i.status)).length;
            const remaining = total - done;

            const sprintStart = data.sprint_data.start ? new Date(data.sprint_data.start) : null;
            const sprintEnd = data.sprint_data.end ? new Date(data.sprint_data.end) : null;
            if (!sprintStart || !sprintEnd) return null;

            const today = new Date();
            const daysElapsed = Math.max(1, Math.floor((today - sprintStart) / (24 * 60 * 60 * 1000)));
            const daysRemaining = Math.max(0, Math.floor((sprintEnd - today) / (24 * 60 * 60 * 1000)));

            // Current velocity (issues/day)
            const currentVelocity = done / daysElapsed;

            // Predict completion
            if (currentVelocity <= 0) {
                return { status: 'at_risk', message: 'No progress yet', confidence: 'low' };
            }

            const daysNeeded = remaining / currentVelocity;
            const predictedEnd = new Date(today.getTime() + daysNeeded * 24 * 60 * 60 * 1000);
            const daysVariance = Math.round((sprintEnd - predictedEnd) / (24 * 60 * 60 * 1000));

            const confidence = daysElapsed >= 3 ? 'high' : 'low';

            if (daysVariance >= 2) {
                return { status: 'ahead', message: `${daysVariance}d ahead`, confidence };
            } else if (daysVariance >= 0) {
                return { status: 'on_track', message: 'On track', confidence };
            } else if (daysVariance >= -2) {
                return { status: 'at_risk', message: `${Math.abs(daysVariance)}d behind`, confidence };
            } else {
                return { status: 'behind', message: `${Math.abs(daysVariance)}d behind`, confidence };
            }
        }

        function getSprintPredictionBadge() {
            const prediction = predictSprintCompletion();
            if (!prediction) return '';

            const colors = {
                ahead: '#238636',
                on_track: '#238636',
                at_risk: '#d29922',
                behind: '#da3633'
            };

            const color = colors[prediction.status] || '#6e7681';
            const opacity = prediction.confidence === 'low' ? '0.7' : '1';

            return `<span style="background:${color};color:#fff;padding:4px 10px;border-radius:12px;font-size:12px;margin-left:10px;opacity:${opacity}">${prediction.message}</span>`;
        }

        function renderSprintChart() {
            const data = window.lastVelocityData;
            if (!data || !data.sprint_data) return;

            const ctx = document.getElementById('velocity-chart').getContext('2d');
            if (window.velocityChart) window.velocityChart.destroy();

            const sprintData = data.sprint_data;
            const issues = getFilteredSprintIssues();
            const sprintStart = sprintData.start ? new Date(sprintData.start) : new Date(Date.now() - 14*24*60*60*1000);
            const sprintEnd = sprintData.end ? new Date(sprintData.end) : new Date();
            const total = issues.length;

            // Generate daily labels for 2 weeks
            const labels = [];
            const cumulativeResolved = [];
            const cumulativeCreated = [];
            const idealBurndown = [];

            let currentDate = new Date(sprintStart);
            const dayMs = 24 * 60 * 60 * 1000;
            let dayIndex = 0;

            while (currentDate <= sprintEnd || dayIndex < 14) {
                const dateStr = currentDate.toISOString().split('T')[0];
                const label = `${currentDate.getMonth()+1}/${currentDate.getDate()}`;
                labels.push(label);

                // Count issues resolved by this date
                const resolvedByDate = issues.filter(i =>
                    i.resolved && i.resolved <= dateStr && ['Done', 'Closed'].includes(i.status)
                ).length;
                cumulativeResolved.push(resolvedByDate);

                // Count issues created by this date (that are in sprint)
                const createdByDate = issues.filter(i =>
                    i.created && i.created <= dateStr
                ).length;
                cumulativeCreated.push(createdByDate);

                // Ideal burndown line (linear from total to 0)
                const daysTotal = Math.ceil((sprintEnd - sprintStart) / dayMs);
                const idealRemaining = total - (total * dayIndex / daysTotal);
                idealBurndown.push(Math.max(0, Math.round(idealRemaining)));

                currentDate = new Date(currentDate.getTime() + dayMs);
                dayIndex++;
                if (dayIndex > 14) break; // Max 2 weeks
            }

            // Current remaining (total - resolved)
            const done = issues.filter(i => ['Done', 'Closed'].includes(i.status)).length;
            const remaining = total - done;

            // Use 8-week velocity based on current B4 filter setting
            const velocitySource = window.b4FilterActive ? data.velocity : (data.velocity_all || data.velocity);
            const totalResolved8wk = velocitySource ? velocitySource.reduce((sum, v) => sum + v.resolved, 0) : 0;
            const avgVelocityPerDay = totalResolved8wk / 56; // 8 weeks = 56 days

            window.velocityChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: `Velocity Trend (${(avgVelocityPerDay * 7).toFixed(1)} SP/wk)`,
                            data: labels.map((_, i) => avgVelocityPerDay * (i + 1)),
                            borderColor: 'rgba(255, 255, 255, 0.4)',
                            borderDash: [5, 5],
                            backgroundColor: 'transparent',
                            fill: false,
                            tension: 0,
                            borderWidth: 2,
                            pointRadius: 0,
                            datalabels: { display: false }
                        },
                        {
                            label: `Resolved (${done}/${total})`,
                            data: cumulativeResolved,
                            borderColor: '#238636',
                            backgroundColor: 'rgba(35, 134, 54, 0.1)',
                            fill: true,
                            tension: 0.3,
                            borderWidth: 3
                        },
                        {
                            label: `Total in Sprint (${total})`,
                            data: cumulativeCreated,
                            borderColor: '#1f6feb',
                            backgroundColor: 'rgba(31, 111, 235, 0.1)',
                            fill: true,
                            tension: 0.3,
                            borderWidth: 3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { reverse: true, labels: { color: '#c9d1d9' } },
                        datalabels: { display: false },
                        title: {
                            display: true,
                            text: `Sprint: ${done}/${total} completed (${Math.round(done/total*100)}%) - ${remaining} remaining`,
                            color: '#c9d1d9',
                            font: { size: 14 }
                        }
                    },
                    scales: {
                        x: { ticks: { color: '#8b949e' }, grid: { color: '#21262d' } },
                        y: { ticks: { color: '#8b949e' }, grid: { color: '#21262d' }, beginAtZero: true }
                    }
                },
                plugins: [ChartDataLabels]
            });
        }

        function renderSprintIssues() {
            const data = window.lastVelocityData;
            if (!data || !data.sprint_data) return;

            const issues = getFilteredSprintIssues();
            const totalAll = data.sprint_data.issues?.length || 0;
            document.getElementById('sprint-issues-count').textContent = window.b4FilterActive ? `${issues.length}/${totalAll}` : issues.length;

            // Sort: In Progress first, then To Do, then Done
            const statusOrder = {'In Progress': 0, 'To Do': 1, 'New': 1, 'Backlog': 2, 'Done': 3, 'Closed': 4, 'Dropped': 5};
            issues.sort((a, b) => (statusOrder[a.status] || 2) - (statusOrder[b.status] || 2));

            const html = issues.map(issue => {
                const statusClass = issue.status.toLowerCase().replace(' ', '-');
                return `<tr>
                    <td><a class="ticket-link" href="https://getnexar.atlassian.net/browse/${issue.key}" target="_blank">${issue.key}</a></td>
                    <td class="truncate" title="${issue.summary}">${issue.summary}</td>
                    <td>${issue.type}</td>
                    <td><span class="status-badge status-${statusClass}">${issue.status}</span></td>
                    <td style="text-align:center;">${issue.story_points || 2}</td>
                </tr>`;
            }).join('');

            document.getElementById('sprint-issues-body').innerHTML = html || '<tr><td colspan="5">No sprint issues</td></tr>';
        }

        function render8WeekChart() {
            const data = window.lastVelocityData;
            if (!data || !data.velocity) return;

            const ctx = document.getElementById('velocity-chart').getContext('2d');
            if (window.velocityChart) window.velocityChart.destroy();

            // Use B4 or all data based on filter
            const velocityData = window.b4FilterActive ? data.velocity : (data.velocity_all || data.velocity);
            const initialOpen = window.b4FilterActive ? (data.initial_open || 0) : (data.initial_open_all || 0);
            const initialBugs = window.b4FilterActive ? (data.initial_bugs || 0) : (data.initial_bugs_all || 0);

            let cumResolved = 0, cumCreated = 0;
            const cumulativeResolved = velocityData.map(v => { cumResolved += v.resolved; return cumResolved; });
            cumCreated = 0;
            const cumulativeCreated = velocityData.map(v => { cumCreated += v.created; return initialOpen + cumCreated; });

            let openBugs = initialBugs;
            const openBugsLine = velocityData.map(v => {
                openBugs += (v.bugs_created || 0) - (v.bugs_resolved || 0);
                return openBugs;
            });

            const totalResolved = velocityData.reduce((sum, v) => sum + v.resolved, 0);
            const avgVelocity = totalResolved / velocityData.length;
            const velocityTrendLine = velocityData.map((v, i) => avgVelocity * (i + 1));

            window.velocityChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: velocityData.map(v => v.week),
                    datasets: [
                        { label: 'Open Bugs', data: openBugsLine, borderColor: '#da3633', backgroundColor: 'rgba(218, 54, 51, 0.1)', fill: true, tension: 0.3, borderWidth: 2 },
                        { label: `Velocity Trend (${avgVelocity.toFixed(1)} SP/wk)`, data: velocityTrendLine, borderColor: 'rgba(255, 255, 255, 0.4)', borderDash: [5, 5], backgroundColor: 'transparent', fill: false, tension: 0, borderWidth: 2, pointRadius: 0, datalabels: { display: false } },
                        { label: 'SP Resolved (cumulative)', data: cumulativeResolved, borderColor: '#238636', backgroundColor: 'rgba(35, 134, 54, 0.1)', fill: true, tension: 0.3 },
                        { label: 'SP Created (cumulative)', data: cumulativeCreated, borderColor: '#1f6feb', backgroundColor: 'rgba(31, 111, 235, 0.1)', fill: true, tension: 0.3 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { reverse: true, labels: { color: '#8b949e' } },
                        datalabels: { display: (ctx) => ctx.dataIndex % 2 === 1, color: '#c9d1d9', font: { size: 10 }, anchor: 'end', align: 'top' }
                    },
                    scales: {
                        x: { ticks: { color: '#8b949e' }, grid: { color: '#21262d' } },
                        y: { ticks: { color: '#8b949e' }, grid: { color: '#21262d' }, beginAtZero: true }
                    }
                },
                plugins: [ChartDataLabels]
            });
        }

        function openChartFullscreen() {
            document.getElementById('chart-fullscreen').style.display = 'block';
            document.body.style.overflow = 'hidden';
            updateFullscreenButtons();
            renderFullscreenChart();
        }

        function updateFullscreenButtons() {
            const sprintBtn = document.getElementById('fullscreen-sprint-btn');
            const b4Btn = document.getElementById('fullscreen-b4-btn');
            const title = document.getElementById('fullscreen-title');
            const sprintData = window.lastVelocityData?.sprint_data;

            if (window.sprintViewActive) {
                sprintBtn.textContent = 'üìä 8 Week View';
                sprintBtn.style.background = '#238636';
                title.textContent = `üìà Velocity (Story Points) (${sprintData?.name || 'Current Sprint'})`;
            } else {
                sprintBtn.textContent = 'üìÖ Sprint View';
                sprintBtn.style.background = '#1f6feb';
                title.textContent = 'üìà Velocity (Story Points) (Last 8 Weeks)';
            }

            if (window.b4FilterActive) {
                b4Btn.textContent = 'üè∑Ô∏è B4 Only';
                b4Btn.style.background = '#238636';
            } else {
                b4Btn.textContent = 'üìã All Issues';
                b4Btn.style.background = '#6e7681';
            }
        }

        function toggleFullscreenView() {
            window.sprintViewActive = !window.sprintViewActive;
            // Update main view buttons too
            const mainBtn = document.getElementById('sprint-velocity-btn');
            const mainTitle = document.getElementById('velocity-title');
            const issuesContainer = document.getElementById('sprint-issues-container');
            const sprintData = window.lastVelocityData?.sprint_data;

            if (window.sprintViewActive) {
                mainBtn.textContent = 'üìä 8 Week View';
                mainBtn.style.background = '#238636';
                mainTitle.textContent = `(${sprintData?.name || 'Current Sprint'})`;
                issuesContainer.style.display = 'block';
            } else {
                mainBtn.textContent = 'üìÖ Sprint View';
                mainBtn.style.background = '#1f6feb';
                mainTitle.textContent = '(Last 8 Weeks)';
                issuesContainer.style.display = 'none';
            }

            updateFullscreenButtons();
            renderFullscreenChart();
        }

        function toggleFullscreenB4Filter() {
            window.b4FilterActive = !window.b4FilterActive;
            // Update main view button too
            const mainBtn = document.getElementById('b4-filter-btn');

            if (window.b4FilterActive) {
                mainBtn.textContent = 'üè∑Ô∏è B4 Only';
                mainBtn.style.background = '#238636';
            } else {
                mainBtn.textContent = 'üìã All Issues';
                mainBtn.style.background = '#6e7681';
            }

            updateFullscreenButtons();
            renderFullscreenChart();
            // Update sprint issues table if visible
            if (window.sprintViewActive) {
                renderSprintIssues();
            }
        }

        function closeChartFullscreen() {
            document.getElementById('chart-fullscreen').style.display = 'none';
            document.body.style.overflow = '';
            if (window.velocityChartFull) {
                window.velocityChartFull.destroy();
                window.velocityChartFull = null;
            }
        }

        function renderFullscreenChart() {
            if (!window.lastVelocityData) return;
            const data = window.lastVelocityData;
            const ctx = document.getElementById('velocity-chart-full').getContext('2d');

            if (window.velocityChartFull) window.velocityChartFull.destroy();

            // Render sprint or 8-week view based on current state
            if (window.sprintViewActive) {
                renderFullscreenSprintChart(ctx, data);
            } else {
                renderFullscreen8WeekChart(ctx, data);
            }
        }

        function renderFullscreen8WeekChart(ctx, data) {
            // Use B4 or all data based on filter
            const velocityData = window.b4FilterActive ? data.velocity : (data.velocity_all || data.velocity);
            const initialOpen = window.b4FilterActive ? (data.initial_open || 0) : (data.initial_open_all || 0);
            const initialBugs = window.b4FilterActive ? (data.initial_bugs || 0) : (data.initial_bugs_all || 0);

            let cumResolved = 0, cumCreated = 0;
            const cumulativeResolved = velocityData.map(v => { cumResolved += v.resolved; return cumResolved; });
            const cumulativeCreated = velocityData.map(v => { cumCreated += v.created; return initialOpen + cumCreated; });

            let openBugs = initialBugs;
            const openBugsLine = velocityData.map(v => {
                openBugs += (v.bugs_created || 0) - (v.bugs_resolved || 0);
                return openBugs;
            });

            const totalResolved = velocityData.reduce((sum, v) => sum + v.resolved, 0);
            const avgVelocity = totalResolved / velocityData.length;
            const velocityTrendLine = velocityData.map((v, i) => avgVelocity * (i + 1));

            window.velocityChartFull = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: velocityData.map(v => v.week),
                    datasets: [
                        { label: 'Open Bugs', data: openBugsLine, borderColor: '#da3633', backgroundColor: 'rgba(218, 54, 51, 0.1)', fill: true, tension: 0.3, borderWidth: 3 },
                        { label: `Velocity Trend (${avgVelocity.toFixed(1)} SP/wk)`, data: velocityTrendLine, borderColor: 'rgba(255, 255, 255, 0.4)', borderDash: [5, 5], backgroundColor: 'transparent', fill: false, tension: 0, borderWidth: 2, pointRadius: 0, datalabels: { display: false } },
                        { label: 'SP Resolved (cumulative)', data: cumulativeResolved, borderColor: '#238636', backgroundColor: 'rgba(35, 134, 54, 0.1)', fill: true, tension: 0.3, borderWidth: 3 },
                        { label: 'SP Created (cumulative)', data: cumulativeCreated, borderColor: '#1f6feb', backgroundColor: 'rgba(31, 111, 235, 0.1)', fill: true, tension: 0.3, borderWidth: 3 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { reverse: true, labels: { color: '#c9d1d9', font: { size: 14 } } },
                        datalabels: { display: (ctx) => ctx.dataIndex % 2 === 1, color: '#c9d1d9', font: { size: 12 }, anchor: 'end', align: 'top' }
                    },
                    scales: {
                        x: { ticks: { color: '#c9d1d9', font: { size: 14 } }, grid: { color: '#21262d' } },
                        y: { ticks: { color: '#c9d1d9', font: { size: 14 } }, grid: { color: '#21262d' }, beginAtZero: true }
                    }
                },
                plugins: [ChartDataLabels]
            });
        }

        function renderFullscreenSprintChart(ctx, data) {
            const sprintData = data.sprint_data;
            const issues = getFilteredSprintIssues();
            const sprintStart = sprintData.start ? new Date(sprintData.start) : new Date(Date.now() - 14*24*60*60*1000);
            const sprintEnd = sprintData.end ? new Date(sprintData.end) : new Date();
            const total = issues.length;

            const labels = [];
            const cumulativeResolved = [];
            const cumulativeCreated = [];

            let currentDate = new Date(sprintStart);
            const dayMs = 24 * 60 * 60 * 1000;
            let dayIndex = 0;

            while (currentDate <= sprintEnd || dayIndex < 14) {
                const dateStr = currentDate.toISOString().split('T')[0];
                labels.push(`${currentDate.getMonth()+1}/${currentDate.getDate()}`);
                const resolvedByDate = issues.filter(i => i.resolved && i.resolved <= dateStr && ['Done', 'Closed'].includes(i.status)).length;
                cumulativeResolved.push(resolvedByDate);
                const createdByDate = issues.filter(i => i.created && i.created <= dateStr).length;
                cumulativeCreated.push(createdByDate);
                currentDate = new Date(currentDate.getTime() + dayMs);
                dayIndex++;
                if (dayIndex > 14) break;
            }

            const done = issues.filter(i => ['Done', 'Closed'].includes(i.status)).length;
            const remaining = total - done;

            // Use 8-week velocity based on current B4 filter setting
            const velocitySource = window.b4FilterActive ? data.velocity : (data.velocity_all || data.velocity);
            const totalResolved8wk = velocitySource ? velocitySource.reduce((sum, v) => sum + v.resolved, 0) : 0;
            const avgVelocityPerDay = totalResolved8wk / 56;

            window.velocityChartFull = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: `Velocity Trend (${(avgVelocityPerDay * 7).toFixed(1)} SP/wk)`, data: labels.map((_, i) => avgVelocityPerDay * (i + 1)), borderColor: 'rgba(255, 255, 255, 0.4)', borderDash: [5, 5], backgroundColor: 'transparent', fill: false, tension: 0, borderWidth: 2, pointRadius: 0, datalabels: { display: false } },
                        { label: `Resolved (${done}/${total})`, data: cumulativeResolved, borderColor: '#238636', backgroundColor: 'rgba(35, 134, 54, 0.1)', fill: true, tension: 0.3, borderWidth: 3 },
                        { label: `Total in Sprint (${total})`, data: cumulativeCreated, borderColor: '#1f6feb', backgroundColor: 'rgba(31, 111, 235, 0.1)', fill: true, tension: 0.3, borderWidth: 3 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { reverse: true, labels: { color: '#c9d1d9', font: { size: 14 } } },
                        datalabels: { display: false },
                        title: { display: true, text: `Sprint: ${done}/${total} completed (${Math.round(done/total*100)}%) - ${remaining} remaining`, color: '#c9d1d9', font: { size: 16 } }
                    },
                    scales: {
                        x: { ticks: { color: '#c9d1d9', font: { size: 14 } }, grid: { color: '#21262d' } },
                        y: { ticks: { color: '#c9d1d9', font: { size: 14 } }, grid: { color: '#21262d' }, beginAtZero: true }
                    }
                },
                plugins: [ChartDataLabels]
            });
        }

        // Handle Escape key to close fullscreen
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeChartFullscreen();
        });

        function sortTickets(field) {
            // Toggle sort direction
            if (window.ticketsSortField === field) {
                window.ticketsSortDir = window.ticketsSortDir === 'asc' ? 'desc' : 'asc';
            } else {
                window.ticketsSortField = field;
                window.ticketsSortDir = 'asc';
            }

            // Sort data
            window.ticketsData.sort((a, b) => {
                let valA = (a[field] || '').toString().toLowerCase();
                let valB = (b[field] || '').toString().toLowerCase();
                if (valA < valB) return window.ticketsSortDir === 'asc' ? -1 : 1;
                if (valA > valB) return window.ticketsSortDir === 'asc' ? 1 : -1;
                return 0;
            });

            // Update sort indicators
            ['key','summary','status','assignee','priority','version'].forEach(f => {
                document.getElementById('tickets-sort-' + f).textContent = '';
            });
            document.getElementById('tickets-sort-' + field).textContent = window.ticketsSortDir === 'asc' ? '‚ñ≤' : '‚ñº';

            window.ticketsPage = 1;
            renderTicketsPage();
        }

        loadDashboard(true);  // Skip JIRA refresh on page load - use cached data
        // Auto-refresh every 5 minutes (skip JIRA refresh, just reload cached data)
        setInterval(() => loadDashboard(true), 300000);
    </script>
</body>
</html>
